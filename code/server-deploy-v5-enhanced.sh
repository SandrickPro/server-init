#!/bin/bash
################################################################################
# Server Deploy Master - Enhanced Edition v5.0
# –ê–≤—Ç–æ—Ä: Sandrick Tech
# –û–ø–∏—Å–∞–Ω–∏–µ: –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–æ–≤ —Å:
#   - –ü–æ–¥—Ä–æ–±–Ω—ã–º–∏ —Ä—É—Å—Å–∫–∏–º–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏ –Ω–∞ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–µ
#   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π htop –≤ dialog-–º–µ–Ω—é
#   - –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞–º–∏ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
#   - –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
#   - –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–π —Å–ø—Ä–∞–≤–∫–æ–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–∫–Ω–∞
#   - MC-style –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
################################################################################

# –°—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:
# -e: –ø—Ä–µ—Ä—ã–≤–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ
# -u: –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –Ω–µ—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∫–∞–∫ –æ—à–∏–±–∫—É
# -o pipefail: –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –∫–æ–¥ –æ—à–∏–±–∫–∏ –∏–∑ pipeline
set -euo pipefail

################################################################################
# –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
################################################################################

# –¶–≤–µ—Ç–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞ –¥–ª—è —Ç–µ—Ä–º–∏–Ω–∞–ª—å–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞ (ANSI escape codes)
RED='\033[0;31m'          # –ö—Ä–∞—Å–Ω—ã–π - –¥–ª—è –æ—à–∏–±–æ–∫
GREEN='\033[0;32m'        # –ó–µ–ª—ë–Ω—ã–π - –¥–ª—è —É—Å–ø–µ—à–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
YELLOW='\033[1;33m'       # –ñ—ë–ª—Ç—ã–π - –¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
BLUE='\033[0;34m'         # –°–∏–Ω–∏–π - –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
MAGENTA='\033[0;35m'      # –ü—É—Ä–ø—É—Ä–Ω—ã–π - –¥–ª—è —à–∞–≥–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
CYAN='\033[0;36m'         # –ì–æ–ª—É–±–æ–π - –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∏ –±–∞–Ω–Ω–µ—Ä–æ–≤
NC='\033[0m'              # No Color - —Å–±—Ä–æ—Å —Ü–≤–µ—Ç–∞ –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É

# –ü—É—Ç–∏ –∫ —Å–∏—Å—Ç–µ–º–Ω—ã–º —Ñ–∞–π–ª–∞–º –∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è–º
STATE_FILE="/srv/sys/.deployment_state.json"     # JSON-—Ñ–∞–π–ª —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è
LOG_FILE="/srv/sys/logs/server-deploy.log"       # –õ–æ–≥-—Ñ–∞–π–ª –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
USERS_FILE="/srv/sys/.users_db.json"             # –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (JSON)
CONFIG_DIR="/srv/sys/configs"                     # –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
TMP_DIR="/srv/sys/tmp"                            # –í—Ä–µ–º–µ–Ω–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–∫—Ä–∏–ø—Ç–∞
PROGRESS_DIR="/srv/sys/tmp/progress"              # –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
HELP_DIR="/srv/sys/help"                          # –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å —Ñ–∞–π–ª–∞–º–∏ —Å–ø—Ä–∞–≤–∫–∏
WWW_DIR="/srv/www"                                # –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è –≤–µ–±-–∫–æ–Ω—Ç–µ–Ω—Ç–∞
BACKUP_DIR="/srv/sys/backups"                     # –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Dialog (–±–∏–±–ª–∏–æ—Ç–µ–∫–∞ TUI - Text User Interface)
DIALOG_HEIGHT=25                                  # –í—ã—Å–æ—Ç–∞ –æ–∫–æ–Ω dialog (–≤ —Å—Ç—Ä–æ–∫–∞—Ö)
DIALOG_WIDTH=80                                   # –®–∏—Ä–∏–Ω–∞ –æ–∫–æ–Ω dialog (–≤ —Å–∏–º–≤–æ–ª–∞—Ö)
DIALOG_BACKTITLE="Server Deployment Master v5.0 - Enhanced Edition"  # –ó–∞–≥–æ–ª–æ–≤–æ–∫ –≤—Å–µ—Ö –æ–∫–æ–Ω

# –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–π —Å–ø—Ä–∞–≤–∫–∏)
CURRENT_CONTEXT="main"                            # –¢–µ–∫—É—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –º–µ–Ω—é

# –ú–∞—Å—Å–∏–≤ PID –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏
declare -a PARALLEL_PIDS=()                       # –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è PID —Ñ–æ–Ω–æ–≤—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤

################################################################################
# –£–¢–ò–õ–ò–¢–´ –ò –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
################################################################################

###
# –§—É–Ω–∫—Ü–∏—è: print_gradient_line
# –û–ø–∏—Å–∞–Ω–∏–µ: –í—ã–≤–æ–¥ —Å—Ç—Ä–æ–∫–∏ —Å –ø–æ—Å–∏–º–≤–æ–ª—å–Ω—ã–º –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º (—Å–∏–Ω–∏–π)
###
print_gradient_line() {
    local text="$1"
    local start_color=45
    local end_color=44
    local length=${#text}
    local i=0

    for (( i=0; i<length; i++ )); do
        local char="${text:$i:1}"
        local color=$(( start_color + (end_color - start_color) * i / (length-1) ))
        echo -ne "\e[38;5;${color}m${char}\e[0m"
    done
    echo
}

###
# –§—É–Ω–∫—Ü–∏—è: print_gradient_line1
# –û–ø–∏—Å–∞–Ω–∏–µ: –í—ã–≤–æ–¥ —Å—Ç—Ä–æ–∫–∏ —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º (–±–µ–ª—ã–π)
###
print_gradient_line1() {
    local text="$1"
    local start_color=255
    local end_color=240
    local length=${#text}
    local i=0

    for (( i=0; i<length; i++ )); do
        local char="${text:$i:1}"
        local color=$(( start_color + (end_color - start_color) * i / (length-1) ))
        echo -ne "\e[38;5;${color}m${char}\e[0m"
    done
    echo
}

###
# –§—É–Ω–∫—Ü–∏—è: print_gradient_line2
# –û–ø–∏—Å–∞–Ω–∏–µ: –í—ã–≤–æ–¥ —Å—Ç—Ä–æ–∫–∏ —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º (–∂—ë–ª—Ç—ã–π)
###
print_gradient_line2() {
    local text="$1"
    local start_color=230
    local end_color=250
    local length=${#text}
    local i=0

    for (( i=0; i<length; i++ )); do
        local char="${text:$i:1}"
        local color=$(( start_color + (end_color - start_color) * i / (length-1) ))
        echo -ne "\e[38;5;${color}m${char}\e[0m"
    done
    echo
}

###
# –§—É–Ω–∫—Ü–∏—è: banner
# –û–ø–∏—Å–∞–Ω–∏–µ: –í—ã–≤–æ–¥–∏—Ç –∫—Ä–∞—Å–∏–≤—ã–π ASCII-–∞—Ä—Ç –ª–æ–≥–æ—Ç–∏–ø —Å —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è: –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
###
banner() {
    clear
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∏—Å—Ç–µ–º–µ
    [ -r /etc/lsb-release ] && . /etc/lsb-release
    if [ -z "$DISTRIB_DESCRIPTION" ] && [ -x /usr/bin/lsb_release ]; then
        DISTRIB_DESCRIPTION=$(lsb_release -s -d)
    fi
    
    # –í—ã–≤–æ–¥–∏–º –∫—Ä–∞—Å–∏–≤—ã–π –±–∞–Ω–Ω–µ—Ä —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º
    print_gradient_line1 " ______ ______ ______ ______ ______ ______"
    print_gradient_line1 "/_____//_____//_____//_____//_____//_____/"
    print_gradient_line "   _____                    __       _        __      ______             __  "
    print_gradient_line "  / ___/ ____ _ ____   ____/ /_____ (_)_____ / /__   /_  __/___   _____ / /_ "
    print_gradient_line "  \__ \ / __ \`// __ \ / __  // ___// // ___// //_/    / /  / _ \ / ___// __ \\"
    print_gradient_line " ___/ // /_/ // / / // /_/ // /   / // /__ / ,<      / /  /  __// /__ / / / /"
    print_gradient_line "/____/ \__,_//_/ /_/ \__,_//_/   /_/ \___//_/|_|    /_/   \___/ \___//_/ /_/ "
    print_gradient_line2 "                                   ______ ______ ______ ______ ______ ______"
    print_gradient_line2 "                                  /_____//_____//_____//_____//_____//_____/"
    
    # –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    print_gradient_line1 "============================================="
    echo -e "üìÖ  Date      : $(date '+%Y-%m-%d %H:%M:%S %Z')"
    echo -e "üìä  OS ver    : $DISTRIB_DESCRIPTION $(uname -o)"
    echo -e "üñ•   Hostname  : $(hostname)"
    echo -e "üïí  Uptime    : $(uptime -p)"
    echo -e "üåê  IP address: $(hostname -I | awk '{print $1}')"
    
    LAST_LOGIN=$(last -n 2 -i $USER 2>/dev/null | awk 'NR==2 {print $3" "$4" "$5" "$6}')
    if [ -z "$LAST_LOGIN" ]; then
        echo -e "üïí  Last Login: first login"
    else
        echo -e "üïí  Last Login: $LAST_LOGIN"
    fi
    
    print_gradient_line1 "---------------------------------------------"
    echo "üñ•   CPU load  : $(uptime | awk -F'load average:' '{ print $2 }')"
    ps -eo pid,user,comm,%cpu,%mem --sort=-%cpu 2>/dev/null | head -n 4
    
    print_gradient_line1 "---------------------------------------------"
    echo "üíæ  Memory    : $(free -h | awk '/Mem:/ {print $3 "/" $2}')"
    ps -eo pid,user,comm,%cpu,%mem --sort=-%mem 2>/dev/null | head -n 4
    
    print_gradient_line1 "--------------------------------------------"
    echo "üì¶  Disk usage: $(df -h / | awk 'NR==2 {print $3 "/" $2 " (" $5 ")"}')"
    print_gradient_line1 "============================================"
    
    sleep 2
}

###
# –§—É–Ω–∫—Ü–∏—è: info
# –û–ø–∏—Å–∞–Ω–∏–µ: –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∑–∞–ø–∏—Å—å—é –≤ –ª–æ–≥
# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: $1 - —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
###
info() { 
    # –í—ã–≤–æ–¥–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∑–µ–ª—ë–Ω–æ–π –º–µ—Ç–∫–æ–π [INFO] –∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø–∏—à–µ–º –≤ –ª–æ–≥
    # tee -a: append (–¥–æ–±–∞–≤–∏—Ç—å) –≤ —Ñ–∞–π–ª –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏
    echo -e "${GREEN}[INFO]${NC} $1" | tee -a "$LOG_FILE"
}

###
# –§—É–Ω–∫—Ü–∏—è: warn
# –û–ø–∏—Å–∞–Ω–∏–µ: –í—ã–≤–æ–¥ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—é—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: $1 - —Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
###
warn() { 
    # –í—ã–≤–æ–¥–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∂—ë–ª—Ç–æ–π –º–µ—Ç–∫–æ–π [WARN]
    echo -e "${YELLOW}[WARN]${NC} $1" | tee -a "$LOG_FILE"
}

###
# –§—É–Ω–∫—Ü–∏—è: error
# –û–ø–∏—Å–∞–Ω–∏–µ: –í—ã–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ
# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: $1 - —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏
###
error() { 
    # –í—ã–≤–æ–¥–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫—Ä–∞—Å–Ω–æ–π –º–µ—Ç–∫–æ–π [ERROR]
    echo -e "${RED}[ERROR]${NC} $1" | tee -a "$LOG_FILE"
}

###
# –§—É–Ω–∫—Ü–∏—è: step
# –û–ø–∏—Å–∞–Ω–∏–µ: –í—ã–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è –æ —Ç–µ–∫—É—â–µ–º —à–∞–≥–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: $1 - –æ–ø–∏—Å–∞–Ω–∏–µ —à–∞–≥–∞
###
step() { 
    # –í—ã–≤–æ–¥–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—É—Ä–ø—É—Ä–Ω–æ–π –º–µ—Ç–∫–æ–π [STEP]
    echo -e "${MAGENTA}[STEP]${NC} $1" | tee -a "$LOG_FILE"
}

################################################################################
# –°–ò–°–¢–ï–ú–ê –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò
################################################################################

###
# –§—É–Ω–∫—Ü–∏—è: init_system
# –û–ø–∏—Å–∞–Ω–∏–µ: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã, —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –∏ —Ñ–∞–π–ª–æ–≤,
#           —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (dialog, tmux, screen, jq, htop)
# –í—ã–∑—ã–≤–∞–µ—Ç—Å—è: –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ —Å–∫—Ä–∏–ø—Ç–∞
###
init_system() {
    step "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã..."
    
    # –°–æ–∑–¥–∞—ë–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –ø–æ–º–æ—â—å—é brace expansion
    # {a,b,c} —Ä–∞–∑–≤–µ—Ä–Ω—ë—Ç—Å—è –≤ —Ç—Ä–∏ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ø—É—Ç–∏
    # -p: —Å–æ–∑–¥–∞—Ç—å –≤—Å–µ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
    mkdir -p /srv/sys/{fail2ban,configs,backups,logs,help,tmp,tmp/progress}
    mkdir -p /srv/www/{html,sites-available,sites-enabled}
    mkdir -p "$TMP_DIR"
    mkdir -p "$PROGRESS_DIR"
    mkdir -p "$WWW_DIR"
    mkdir -p "$BACKUP_DIR"
    
    # –°–æ–∑–¥–∞—ë–º –ø—É—Å—Ç—ã–µ —Ñ–∞–π–ª—ã, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
    # touch: –æ–±–Ω–æ–≤–ª—è–µ—Ç –≤—Ä–µ–º—è –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏–ª–∏ —Å–æ–∑–¥–∞—ë—Ç —Ñ–∞–π–ª
    touch "$STATE_FILE" "$LOG_FILE" "$USERS_FILE"
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç—Ä–æ–≥–∏–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –Ω–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã
    # 600 = rw------- (—Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å/–ø–∏—Å–∞—Ç—å)
    chmod 600 "$STATE_FILE" "$USERS_FILE"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤ –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏
    info "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
    
    # –ú–∞—Å—Å–∏–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
    local packages=(dialog whiptail tmux screen jq htop)
    local missing_packages=()
    
    # –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –ø–∞–∫–µ—Ç—ã –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏—Ö –Ω–∞–ª–∏—á–∏–µ
    for pkg in "${packages[@]}"; do
        # command -v: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∫–æ–º–∞–Ω–¥—ã –≤ —Å–∏—Å—Ç–µ–º–µ
        # &> /dev/null: –ø–æ–¥–∞–≤–ª—è–µ–º –≤–µ—Å—å –≤—ã–≤–æ–¥ (stdout –∏ stderr)
        if ! command -v "$pkg" &> /dev/null; then
            missing_packages+=("$pkg")
        fi
    done
    
    # –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –ø–∞–∫–µ—Ç—ã, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Ö
    if [ ${#missing_packages[@]} -gt 0 ]; then
        info "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –ø–∞–∫–µ—Ç–æ–≤: ${missing_packages[*]}"
        # -qq: –æ—á–µ–Ω—å —Ç–∏—Ö–∏–π —Ä–µ–∂–∏–º (–º–∏–Ω–∏–º—É–º –≤—ã–≤–æ–¥–∞)
        apt-get update -qq
        # 2>/dev/null: –ø–æ–¥–∞–≤–ª—è–µ–º stderr, || true: –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏
        apt-get install -y "${missing_packages[@]}" 2>/dev/null || true
    else
        info "–í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
    fi
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    init_users_db
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–π —Å–ø—Ä–∞–≤–∫–∏
    init_help_files
    
    info "‚úÖ –°–∏—Å—Ç–µ–º–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ"
}

################################################################################
# –°–ò–°–¢–ï–ú–ê –£–ü–†–ê–í–õ–ï–ù–ò–Ø –°–û–°–¢–û–Ø–ù–ò–ï–ú (State Management)
################################################################################

###
# –§—É–Ω–∫—Ü–∏—è: save_state
# –û–ø–∏—Å–∞–Ω–∏–µ: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞—Ä—ã –∫–ª—é—á-–∑–Ω–∞—á–µ–Ω–∏–µ –≤ JSON-—Ñ–∞–π–ª —Å–æ—Å—Ç–æ—è–Ω–∏—è
# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
#   $1 - –∫–ª—é—á (–Ω–∞–∑–≤–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞)
#   $2 - –∑–Ω–∞—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç: jq (JSON processor) –¥–ª—è –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏ —Å JSON
###
save_state() {
    local key="$1"        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–µ—Ä–≤—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç –∫–∞–∫ –∫–ª—é—á
    local value="$2"      # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ç–æ—Ä–æ–π –∞—Ä–≥—É–º–µ–Ω—Ç –∫–∞–∫ –∑–Ω–∞—á–µ–Ω–∏–µ
    
    # jq -n: —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π JSON –æ–±—ä–µ–∫—Ç —Å –Ω—É–ª—è
    # --arg: –ø–µ—Ä–µ–¥–∞—Ç—å –∞—Ä–≥—É–º–µ–Ω—Ç –≤ jq (–±–µ–∑–æ–ø–∞—Å–Ω–æ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã)
    # jq -s 'add': –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –¥–≤–∞ JSON-–æ–±—ä–µ–∫—Ç–∞
    # > file.tmp: —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
    # 2>/dev/null: –ø–æ–¥–∞–≤–∏—Ç—å –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ JSON
    # || echo: –µ—Å–ª–∏ jq –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Å—Ç–æ–π JSON
    jq -n --arg k "$key" --arg v "$value" "{\"$k\": \"$v\"}" | \
        jq -s 'add' "$STATE_FILE" - > "$STATE_FILE.tmp" 2>/dev/null || \
        echo "{\"$key\": \"$value\"}" > "$STATE_FILE.tmp"
    
    # –ê—Ç–æ–º–∞—Ä–Ω–æ –∑–∞–º–µ–Ω—è–µ–º —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª –Ω–æ–≤—ã–º (mv –∞—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è)
    mv "$STATE_FILE.tmp" "$STATE_FILE"
}

###
# –§—É–Ω–∫—Ü–∏—è: get_state
# –û–ø–∏—Å–∞–Ω–∏–µ: –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ JSON-—Ñ–∞–π–ª–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ –∫–ª—é—á—É
# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
#   $1 - –∫–ª—é—á –¥–ª—è –ø–æ–∏—Å–∫–∞
# –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: –ó–Ω–∞—á–µ–Ω–∏–µ –∫–ª—é—á–∞ –∏–ª–∏ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
###
get_state() {
    local key="$1"        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–ª—é—á –¥–ª—è –ø–æ–∏—Å–∫–∞
    
    # jq -r: raw output (–±–µ–∑ –∫–∞–≤—ã—á–µ–∫)
    # .$key: –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ –∫–ª—é—á—É –≤ JSON
    # // empty: –µ—Å–ª–∏ –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω, –≤–µ—Ä–Ω—É—Ç—å empty (–ø—É—Å—Ç–æ—Ç—É)
    # 2>/dev/null: –ø–æ–¥–∞–≤–∏—Ç—å –æ—à–∏–±–∫–∏
    # || echo "": –µ—Å–ª–∏ jq –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –≤–µ—Ä–Ω—É—Ç—å –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
    jq -r ".$key // empty" "$STATE_FILE" 2>/dev/null || echo ""
}

################################################################################
# –°–ò–°–¢–ï–ú–ê –ö–û–ù–¢–ï–ö–°–¢–ù–û–ô –°–ü–†–ê–í–ö–ò
################################################################################

###
# –§—É–Ω–∫—Ü–∏—è: init_help_files
# –û–ø–∏—Å–∞–Ω–∏–µ: –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ —Å–ø—Ä–∞–≤–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –º–µ–Ω—é
# –í—ã–∑—ã–≤–∞–µ—Ç—Å—è: –ü—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã
###
init_help_files() {
    info "–°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ —Å–ø—Ä–∞–≤–∫–∏..."
    
    # –°–ø—Ä–∞–≤–∫–∞ –¥–ª—è –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
    cat > "$HELP_DIR/main.txt" << 'EOF'
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                    –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ - –°–ü–†–ê–í–ö–ê                    ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

–≠—Ç–æ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å–∏—Å—Ç–µ–º—ã —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞.

–î–û–°–¢–£–ü–ù–´–ï –†–ê–ó–î–ï–õ–´:
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏: –°–æ–∑–¥–∞–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ, –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ—Å—Ç—É–ø–∞
- –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–µ–±, –ø–æ—á—Ç—ã, –ë–î, VPN –∏ –¥—Ä.
- MC-Style –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: –ú–Ω–æ–≥–æ–ø–∞–Ω–µ–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫–∞–∫ –≤ Midnight Commander
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã: –ü—Ä–æ—Å–º–æ—Ç—Ä htop, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏, –ª–æ–≥–æ–≤
- –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ: Backup –∏ restore –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π

–ì–û–†–Ø–ß–ò–ï –ö–õ–ê–í–ò–®–ò:
- ESC: –í—ã—Ö–æ–¥ –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –º–µ–Ω—é
- Tab: –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏
- Enter: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞
- F1: –°–ø—Ä–∞–≤–∫–∞ (–≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –æ–∫–Ω–∞—Ö)

–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:
1. –ù–∞—á–Ω–∏—Ç–µ —Å —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ SSH-–¥–æ—Å—Ç—É–ø
3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Å–µ—Ä–≤–∏—Å—ã
4. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
5. –°–æ–∑–¥–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏
EOF

    # –°–ø—Ä–∞–≤–∫–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
    cat > "$HELP_DIR/users.txt" << 'EOF'
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë              –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–ú–ò - –°–ü–†–ê–í–ö–ê             ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

–ú–æ–¥—É–ª—å –¥–ª—è –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.

–§–£–ù–ö–¶–ò–ò:
1. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
   - –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–π —É—á—ë—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏
   - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞—Ä–æ–ª—è
   - –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–µ–π (user/admin/developer/devops)
   - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—ã

2. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ SSH-–∫–ª—é—á–∞–º–∏:
   - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—É–±–ª–∏—á–Ω—ã—Ö –∫–ª—é—á–µ–π
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ –∫–ª—é—á–∞–º
   - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ authorized_keys

3. Sudo-–¥–æ—Å—Ç—É–ø:
   - –ü–æ–ª–Ω—ã–π sudo (ALL)
   - Sudo –±–µ–∑ –ø–∞—Ä–æ–ª—è (NOPASSWD)
   - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
   - –û—Ç–∑—ã–≤ –ø—Ä–∞–≤

4. –ö–≤–æ—Ç—ã:
   - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ª–∏–º–∏—Ç–æ–≤ –Ω–∞ –¥–∏—Å–∫–æ–≤–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ
   - Soft –∏ hard limits

5. ACL-–ø—Ä–∞–≤–∞:
   - –î–µ—Ç–∞–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞
   - –ü—Ä–∞–≤–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ñ–∞–π–ª–æ–≤ –∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π

–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨:
- –í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
- –ü–∞—Ä–æ–ª–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ
- SSH-–∫–ª—é—á–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–µ–µ –ø–∞—Ä–æ–ª–µ–π
- –†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
EOF

    # –°–ø—Ä–∞–≤–∫–∞ –¥–ª—è —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
    cat > "$HELP_DIR/services.txt" << 'EOF'
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë            –†–ê–ó–í–Å–†–¢–´–í–ê–ù–ò–ï –°–ï–†–í–ò–°–û–í - –°–ü–†–ê–í–ö–ê                  ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

–ú–æ–¥—É–ª—å –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤.

–î–û–°–¢–£–ü–ù–´–ï –°–ï–†–í–ò–°–´:

1. –í–ï–ë-–°–ï–†–í–ï–† (Nginx):
   - Nginx —Å –º–æ–¥—É–ª—è–º–∏ (GeoIP, cache-purge, headers-more)
   - SSL/TLS –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
   - Rate limiting
   - –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ —Ö–æ—Å—Ç—ã

2. –ü–û–ß–¢–û–í–´–ô –°–ï–†–í–ï–†:
   - Postfix / Exim4 (MTA)
   - Dovecot (IMAP/POP3)
   - DKIM/SPF/DMARC
   - ClamAV + SpamAssassin
   - Roundcube (webmail)

3. –ë–ê–ó–´ –î–ê–ù–ù–´–•:
   - MySQL 8.0 / MariaDB 10.11
   - PostgreSQL 15
   - MongoDB 7.0
   - Redis
   - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π

4. VPN:
   - OpenVPN (—Å Easy-RSA)
   - WireGuard (—Å QR-–∫–æ–¥–∞–º–∏)
   - IKEv2/IPsec
   - L2TP/IPsec

5. FTP:
   - vsftpd / ProFTPD / Pure-FTPd
   - SSL/TLS —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
   - Passive mode

6. DNS:
   - BIND9 (—Å DNSSEC)
   - Unbound (DoT)
   - dnsmasq
   - PowerDNS (—Å web-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º)

7. –ú–û–ù–ò–¢–û–†–ò–ù–ì:
   - Netdata (real-time)
   - Prometheus + Grafana
   - Zabbix
   - Icinga2

–ü–ê–†–ê–õ–õ–ï–õ–¨–ù–ê–Ø –£–°–¢–ê–ù–û–í–ö–ê:
–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞.
–ü—Ä–æ–≥—Ä–µ—Å—Å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.

–ü–û–°–õ–ï –£–°–¢–ê–ù–û–í–ö–ò:
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤: systemctl status <service>
- –ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏: journalctl -u <service>
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ firewall: iptables -I INPUT -p tcp --dport <port> -j ACCEPT && iptables-save > /etc/iptables/rules.v4
EOF

    # –°–ø—Ä–∞–≤–∫–∞ –¥–ª—è MC-Style –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    cat > "$HELP_DIR/mc-style.txt" << 'EOF'
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                MC-STYLE –ò–ù–¢–ï–†–§–ï–ô–° - –°–ü–†–ê–í–ö–ê                  ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

–ú–Ω–æ–≥–æ–ø–∞–Ω–µ–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π Midnight Commander.

–ö–û–ú–ü–û–ù–û–í–ö–ê –≠–ö–†–ê–ù–ê:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   –†–ï–î–ê–ö–¢–û–† –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ô                      ‚îÇ
‚îÇ                        (nano/vim)                            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ         –õ–û–ì–ò (tail -f)          ‚îÇ    –ú–û–ù–ò–¢–û–†–ò–ù–ì (htop)       ‚îÇ
‚îÇ                                 ‚îÇ                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

–ü–ê–ù–ï–õ–ò:
1. –í–µ—Ä—Ö–Ω—è—è: –†–µ–¥–∞–∫—Ç–æ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
   - –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ /etc
   - –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
   - –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞

2. –ù–∏–∂–Ω—è—è –ª–µ–≤–∞—è: –õ–æ–≥–∏
   - –†–µ–∞–ª-—Ç–∞–π–º –≤—ã–≤–æ–¥ –ª–æ–≥–æ–≤
   - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —É—Ä–æ–≤–Ω—è–º
   - –ü–æ–∏—Å–∫ –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É

3. –ù–∏–∂–Ω—è—è –ø—Ä–∞–≤–∞—è: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
   - htop: –ø—Ä–æ—Ü–µ—Å—Å—ã, CPU, –ø–∞–º—è—Ç—å
   - –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –Ω–∞–≥—Ä—É–∑–∫–µ
   - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏

–£–ü–†–ê–í–õ–ï–ù–ò–ï TMUX:
- Ctrl+B %: –†–∞–∑–¥–µ–ª–∏—Ç—å –ø–∞–Ω–µ–ª—å –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ
- Ctrl+B ": –†–∞–∑–¥–µ–ª–∏—Ç—å –ø–∞–Ω–µ–ª—å –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ
- Ctrl+B —Å—Ç—Ä–µ–ª–∫–∏: –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –ø–∞–Ω–µ–ª—è–º–∏
- Ctrl+B D: –û—Ç—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –æ—Ç —Å–µ—Å—Å–∏–∏
- Ctrl+B X: –ó–∞–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å
- Ctrl+B Z: –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å/—Å–≤–µ—Ä–Ω—É—Ç—å –ø–∞–Ω–µ–ª—å

–í–ê–†–ò–ê–ù–¢–´ –ö–û–ú–ü–û–ù–û–í–ö–ò:
1. Horizontal: –î–≤–µ –ø–∞–Ω–µ–ª–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ
2. Vertical: –î–≤–µ –ø–∞–Ω–µ–ª–∏ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ
3. Quad: –ß–µ—Ç—ã—Ä–µ –ø–∞–Ω–µ–ª–∏ (2x2)
4. Triple-H: –¢—Ä–∏ –ø–∞–Ω–µ–ª–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ
5. Triple-V: –¢—Ä–∏ –ø–∞–Ω–µ–ª–∏ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ

–ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï:
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ MC-Style –¥–ª—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–∏—Å—Ç–µ–º—ã,
—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥–æ–≤ –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤.
EOF

    # –°–ø—Ä–∞–≤–∫–∞ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
    cat > "$HELP_DIR/monitoring.txt" << 'EOF'
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë               –ú–û–ù–ò–¢–û–†–ò–ù–ì –°–ò–°–¢–ï–ú–´ - –°–ü–†–ê–í–ö–ê                   ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∑–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º —Å–µ—Ä–≤–µ—Ä–∞.

HTOP:
–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä—â–∏–∫ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤.

–ì–û–†–Ø–ß–ò–ï –ö–õ–ê–í–ò–®–ò HTOP:
- F1/h: –°–ø—Ä–∞–≤–∫–∞
- F2/S: –ù–∞—Å—Ç—Ä–æ–π–∫–∏
- F3//: –ü–æ–∏—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞
- F4/\\: –§–∏–ª—å—Ç—Ä
- F5/t: –î—Ä–µ–≤–æ–≤–∏–¥–Ω—ã–π —Ä–µ–∂–∏–º
- F6/<>: –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Å—Ç–æ–ª–±—Ü—É
- F7/]: –£–≤–µ–ª–∏—á–∏—Ç—å nice (–ø–æ–Ω–∏–∑–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
- F8/[: –£–º–µ–Ω—å—à–∏—Ç—å nice (–ø–æ–≤—ã—Å–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
- F9/k: –£–±–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å
- F10/q: –í—ã—Ö–æ–¥

- Space: –û—Ç–º–µ—Ç–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å
- U: –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- K: –°–∫—Ä—ã—Ç—å kernel threads
- H: –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å user threads
- P: –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ CPU
- M: –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –ø–∞–º—è—Ç–∏
- T: –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏

–ò–ù–§–û–†–ú–ê–¶–ò–Ø –í HTOP:
- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å: CPU, –ø–∞–º—è—Ç—å, swap, –∑–∞–≥—Ä—É–∑–∫–∞
- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å: –°–ø–∏—Å–æ–∫ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
- PID: ID –ø—Ä–æ—Ü–µ—Å—Å–∞
- USER: –í–ª–∞–¥–µ–ª–µ—Ü –ø—Ä–æ—Ü–µ—Å—Å–∞
- %CPU: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞
- %MEM: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
- TIME+: –°—É–º–º–∞—Ä–Ω–æ–µ –≤—Ä–µ–º—è CPU
- COMMAND: –ö–æ–º–∞–Ω–¥–∞/–ø—Ä–æ—Ü–µ—Å—Å

NETDATA:
–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.
URL: http://your-server:19999

PROMETHEUS + GRAFANA:
–°–±–æ—Ä –º–µ—Ç—Ä–∏–∫ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è.
Grafana: http://your-server:3000
Prometheus: http://your-server:9090

–ü–û–õ–ï–ó–ù–´–ï –ö–û–ú–ê–ù–î–´:
- top: –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ htop
- iotop: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ I/O
- nethogs: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–µ—Ç–∏ –ø–æ –ø—Ä–æ—Ü–µ—Å—Å–∞–º
- iftop: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–µ—Ç–µ–≤–æ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞
- atop: –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
EOF

    # –°–ø—Ä–∞–≤–∫–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞–º–∏
    cat > "$HELP_DIR/installation.txt" << 'EOF'
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë            –°–ò–°–¢–ï–ú–ê –£–°–¢–ê–ù–û–í–ö–ò - –°–ü–†–ê–í–ö–ê                       ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

–ü—Ä–æ—Ü–µ—Å—Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å –≤–∏–∑—É–∞–ª—å–Ω—ã–º–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.

–û–°–û–ë–ï–ù–ù–û–°–¢–ò:

1. –ü–ê–†–ê–õ–õ–ï–õ–¨–ù–ê–Ø –£–°–¢–ê–ù–û–í–ö–ê:
   - –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —è–¥–µ—Ä –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞
   - –£—Å–∫–æ—Ä–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤ 3-5 —Ä–∞–∑

2. –ü–†–û–ì–†–ï–°–°-–ë–ê–†–´:
   - –û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏
   - –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
   - –ü—Ä–æ—Ü–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
   - –û—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è (–ø—Ä–∏–º–µ—Ä–Ω–æ)

3. –°–¢–ê–¢–£–° –í –†–ï–ê–õ–¨–ù–û–ú –í–†–ï–ú–ï–ù–ò:
   - –¢–µ–∫—É—â–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è
   - –£—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
   - –û—à–∏–±–∫–∏ –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
   - –õ–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

4. –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨:
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π
   - –û—Ç–∫–∞—Ç –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π –∫–æ–Ω—Ñ–∏–≥–æ–≤
   - –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤

–≠–¢–ê–ü–´ –£–°–¢–ê–ù–û–í–ö–ò:
1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–≤ –ø–∞–∫–µ—Ç–æ–≤
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
3. –ó–∞–≥—Ä—É–∑–∫–∞ –ø–∞–∫–µ—Ç–æ–≤
4. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)
5. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
6. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
7. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

–ü–û–°–õ–ï –£–°–¢–ê–ù–û–í–ö–ò:
- –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–≤–æ–¥–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ
- –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–í–û–ó–ú–û–ñ–ù–´–ï –ü–†–û–ë–õ–ï–ú–´:
- –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ
- –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø–æ—Ä—Ç–æ–≤
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- –ù–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –≤–µ—Ä—Å–∏–π

–†–ï–®–ï–ù–ò–ï: –ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ –≤ /var/log/server-deploy.log
EOF

    info "‚úÖ –§–∞–π–ª—ã —Å–ø—Ä–∞–≤–∫–∏ —Å–æ–∑–¥–∞–Ω—ã"
}

###
# –§—É–Ω–∫—Ü–∏—è: show_context_help
# –û–ø–∏—Å–∞–Ω–∏–µ: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–π —Å–ø—Ä–∞–≤–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –º–µ–Ω—é
# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
#   $1 - –∫–æ–Ω—Ç–µ–∫—Å—Ç (main/users/services/mc-style/monitoring/installation)
###
show_context_help() {
    local context="${1:-$CURRENT_CONTEXT}"    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–ª–∏ —Ç–µ–∫—É—â–∏–π
    local help_file="$HELP_DIR/${context}.txt"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ —Å–ø—Ä–∞–≤–∫–∏
    if [[ -f "$help_file" ]]; then
        # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ —Å–ø—Ä–∞–≤–∫–∏ –≤ textbox dialog
        dialog --title "–°–ø—Ä–∞–≤–∫–∞: $context" \
               --textbox "$help_file" \
               $DIALOG_HEIGHT $DIALOG_WIDTH
    else
        # –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        dialog --title "–û—à–∏–±–∫–∞" \
               --msgbox "–§–∞–π–ª —Å–ø—Ä–∞–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω: $help_file" \
               8 50
    fi
}

###
# –§—É–Ω–∫—Ü–∏—è: set_context
# –û–ø–∏—Å–∞–Ω–∏–µ: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–π —Å–ø—Ä–∞–≤–∫–∏
# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
#   $1 - –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
###
set_context() {
    CURRENT_CONTEXT="$1"
    info "–ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑–º–µ–Ω—ë–Ω –Ω–∞: $CURRENT_CONTEXT"
}

################################################################################
# –°–ò–°–¢–ï–ú–ê –ü–†–û–ì–†–ï–°–°-–ë–ê–†–û–í
################################################################################

###
# –§—É–Ω–∫—Ü–∏—è: show_progress
# –û–ø–∏—Å–∞–Ω–∏–µ: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ –¥–ª—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏
# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
#   $1 - –∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ–ø–µ—Ä–∞—Ü–∏–∏
#   $2 - —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
#   $3 - –ø—Ä–æ—Ü–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (0-100)
###
show_progress() {
    local title="$1"
    local text="$2"
    local percent="$3"
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º dialog --gauge –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
    # –§–æ—Ä–º–∞—Ç: echo –ø—Ä–æ—Ü–µ–Ω—Ç | dialog --gauge —Ç–µ–∫—Å—Ç –≤—ã—Å–æ—Ç–∞ —à–∏—Ä–∏–Ω–∞ –Ω–∞—á–∞–ª—å–Ω—ã–π_–ø—Ä–æ—Ü–µ–Ω—Ç
    echo "$percent" | dialog --title "$title" \
                             --gauge "$text" \
                             10 70 0
}

###
# –§—É–Ω–∫—Ü–∏—è: progress_bar_demo
# –û–ø–∏—Å–∞–Ω–∏–µ: –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
###
progress_bar_demo() {
    {
        # –¶–∏–∫–ª –æ—Ç 0 –¥–æ 100 —Å —à–∞–≥–æ–º 10
        for i in {0..100..10}; do
            # –í—ã–≤–æ–¥–∏–º —Ç–µ–∫—É—â–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç
            echo $i
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            echo "XXX"
            echo "–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏..."
            echo "–ü—Ä–æ–≥—Ä–µ—Å—Å: $i%"
            echo "XXX"
            # –ó–∞–¥–µ—Ä–∂–∫–∞ 0.5 —Å–µ–∫—É–Ω–¥—ã
            sleep 0.5
        done
    } | dialog --title "–ü—Ä–æ–≥—Ä–µ—Å—Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏" \
               --gauge "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è..." \
               10 70 0
}

###
# –§—É–Ω–∫—Ü–∏—è: parallel_install_with_progress
# –û–ø–∏—Å–∞–Ω–∏–µ: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
#   $@ - –º–∞—Å—Å–∏–≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏
###
parallel_install_with_progress() {
    local components=("$@")                   # –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞—Å—Å–∏–≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
    local total=${#components[@]}             # –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
    local completed=0                         # –°—á—ë—Ç—á–∏–∫ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
    
    info "–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ $total –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤..."
    
    # –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
    for comp in "${components[@]}"; do
        echo "0" > "$PROGRESS_DIR/${comp}.progress"
    done
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –≤ —Ñ–æ–Ω–µ
    for comp in "${components[@]}"; do
        (
            # –ò–º–∏—Ç–∞—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é —É—Å—Ç–∞–Ω–æ–≤–∫–∏)
            install_component "$comp"
        ) &
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º PID —Ñ–æ–Ω–æ–≤–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
        PARALLEL_PIDS+=($!)
    done
    
    # –ú–æ–Ω–∏—Ç–æ—Ä–∏–º –ø—Ä–æ–≥—Ä–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    {
        while [ $completed -lt $total ]; do
            completed=0
            local total_progress=0
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
            for comp in "${components[@]}"; do
                local comp_progress=$(cat "$PROGRESS_DIR/${comp}.progress" 2>/dev/null || echo "0")
                total_progress=$((total_progress + comp_progress))
                
                # –ï—Å–ª–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –∑–∞–≤–µ—Ä—à—ë–Ω (100%), —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫
                if [ "$comp_progress" -eq 100 ]; then
                    ((completed++))
                fi
            done
            
            # –í—ã—á–∏—Å–ª—è–µ–º –æ–±—â–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç
            local overall_percent=$((total_progress / total))
            
            # –í—ã–≤–æ–¥–∏–º –æ–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å
            echo "$overall_percent"
            echo "XXX"
            echo "–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤: $completed –∏–∑ $total"
            echo "–û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å: $overall_percent%"
            echo ""
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
            for comp in "${components[@]}"; do
                local comp_progress=$(cat "$PROGRESS_DIR/${comp}.progress" 2>/dev/null || echo "0")
                echo "$comp: $comp_progress%"
            done
            echo "XXX"
            
            # –ü–∞—É–∑–∞ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
            sleep 1
        done
        
        # –ü–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º 100%
        echo "100"
    } | dialog --title "–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤" \
               --gauge "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —É—Å—Ç–∞–Ω–æ–≤–∫–µ..." \
               20 70 0
    
    # –û–∂–∏–¥–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö —Ñ–æ–Ω–æ–≤—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
    wait "${PARALLEL_PIDS[@]}"
    
    # –û—á–∏—â–∞–µ–º –º–∞—Å—Å–∏–≤ PID
    PARALLEL_PIDS=()
    
    info "‚úÖ –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    dialog --title "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞" \
           --msgbox "–í—Å–µ $total –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!" \
           8 50
}

###
# –§—É–Ω–∫—Ü–∏—è: install_component
# –û–ø–∏—Å–∞–Ω–∏–µ: –ò–º–∏—Ç–∞—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
#   $1 - –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
# –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (deploy_web_server –∏ —Ç.–¥.)
###
install_component() {
    local component="$1"
    local progress_file="$PROGRESS_DIR/${component}.progress"
    
    info "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ $component..."
    
    # –ò–º–∏—Ç–∞—Ü–∏—è —ç—Ç–∞–ø–æ–≤ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º
    for progress in {10..100..10}; do
        echo "$progress" > "$progress_file"
        # –°–ª—É—á–∞–π–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ —Ä–µ–∞–ª—å–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏
        sleep $((RANDOM % 3 + 1))
    done
    
    info "‚úÖ $component —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    return 0
}

################################################################################
# HTOP –í DIALOG
################################################################################

###
# –§—É–Ω–∫—Ü–∏—è: show_htop_dialog
# –û–ø–∏—Å–∞–Ω–∏–µ: –ó–∞–ø—É—Å–∫ htop –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
# –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç gnome-terminal/xterm –¥–ª—è –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–≥–æ —Ä–µ–∂–∏–º–∞
#              –∏–ª–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ —Ç–µ–∫—É—â–µ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –¥–ª—è SSH-—Å–µ—Å—Å–∏–π
###
show_htop_dialog() {
    set_context "monitoring"      # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
    
    # –û—á–∏—â–∞–µ–º —ç–∫—Ä–∞–Ω dialog –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º htop
    clear
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    dialog --title "–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã" \
           --infobox "–ó–∞–ø—É—Å–∫ htop...\n\n–î–ª—è –≤—ã—Ö–æ–¥–∞ –Ω–∞–∂–º–∏—Ç–µ q" \
           6 40
    
    sleep 1
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º htop –≤–æ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
    # -d 10: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 1 —Å–µ–∫—É–Ω–¥—É (10 deciseconds)
    htop -d 10
    
    # –ü–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è htop –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ dialog
    dialog --title "–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥" \
           --msgbox "–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–≤–µ—Ä—à—ë–Ω" \
           6 30
}

###
# –§—É–Ω–∫—Ü–∏—è: monitoring_menu
# –û–ø–∏—Å–∞–Ω–∏–µ: –ú–µ–Ω—é –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å –≤—ã–±–æ—Ä–æ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
###
monitoring_menu() {
    set_context "monitoring"      # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
    
    while true; do
        # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
        local choice=$(dialog --clear \
            --backtitle "$DIALOG_BACKTITLE" \
            --title "–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã" \
            --menu "–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç:" \
            20 60 10 \
            1 "htop - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤" \
            2 "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã (uptime, free, df)" \
            3 "–°–µ—Ç–µ–≤—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (netstat)" \
            4 "–ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤" \
            5 "–ê–∫—Ç–∏–≤–Ω—ã–µ —Å–ª—É–∂–±—ã (systemctl)" \
            6 "–î–∏—Å–∫–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (iotop)" \
            7 "–°–µ—Ç–µ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (iftop)" \
            H "üìñ –°–ø—Ä–∞–≤–∫–∞" \
            0 "‚óÄ –ù–∞–∑–∞–¥" \
            3>&1 1>&2 2>&3)
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        case $choice in
            1)  show_htop_dialog ;;
            2)  show_system_stats ;;
            3)  show_network_connections ;;
            4)  show_logs_menu ;;
            5)  show_services_status ;;
            6)  show_iotop ;;
            7)  show_iftop ;;
            H|h) show_context_help "monitoring" ;;
            0|"") return ;;     # –ü—É—Å—Ç–æ–π –≤—ã–±–æ—Ä (ESC) –∏–ª–∏ 0 - –≤—ã—Ö–æ–¥
        esac
    done
}

###
# –§—É–Ω–∫—Ü–∏—è: show_system_stats
# –û–ø–∏—Å–∞–Ω–∏–µ: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ dialog textbox
###
show_system_stats() {
    # –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
    local stats_file="$TMP_DIR/system_stats.txt"
    
    {
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo "           –°–¢–ê–¢–ò–°–¢–ò–ö–ê –°–ò–°–¢–ï–ú–´"
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo ""
        echo "‚è±  –í–†–ï–ú–Ø –†–ê–ë–û–¢–´:"
        uptime
        echo ""
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo "üíæ –ü–ê–ú–Ø–¢–¨:"
        free -h
        echo ""
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo "üíø –î–ò–°–ö–ò:"
        df -h
        echo ""
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo "üñ•  –ó–ê–ì–†–£–ó–ö–ê CPU (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –º–∏–Ω—É—Ç):"
        mpstat 1 1 2>/dev/null || echo "mpstat –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (apt install sysstat)"
        echo ""
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo "üå°  –¢–ï–ú–ü–ï–†–ê–¢–£–†–ê (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ):"
        sensors 2>/dev/null || echo "sensors –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (apt install lm-sensors)"
        echo ""
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    } > "$stats_file"
    
    # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤ dialog textbox
    dialog --title "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã" \
           --textbox "$stats_file" \
           $DIALOG_HEIGHT $DIALOG_WIDTH
    
    # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
    rm -f "$stats_file"
}

###
# –§—É–Ω–∫—Ü–∏—è: show_network_connections
# –û–ø–∏—Å–∞–Ω–∏–µ: –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Ç–µ–≤—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
###
show_network_connections() {
    local conn_file="$TMP_DIR/connections.txt"
    
    {
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo "         –°–ï–¢–ï–í–´–ï –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø"
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo ""
        netstat -tunapl 2>/dev/null || ss -tunapl
    } > "$conn_file"
    
    dialog --title "–°–µ—Ç–µ–≤—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è" \
           --textbox "$conn_file" \
           $DIALOG_HEIGHT $DIALOG_WIDTH
    
    rm -f "$conn_file"
}

###
# –§—É–Ω–∫—Ü–∏—è: show_services_status
# –û–ø–∏—Å–∞–Ω–∏–µ: –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–ª—É–∂–±
###
show_services_status() {
    local services_file="$TMP_DIR/services.txt"
    
    {
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo "         –°–¢–ê–¢–£–° –°–õ–£–ñ–ë SYSTEMD"
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo ""
        systemctl list-units --type=service --all
    } > "$services_file"
    
    dialog --title "–°—Ç–∞—Ç—É—Å —Å–ª—É–∂–±" \
           --textbox "$services_file" \
           $DIALOG_HEIGHT $DIALOG_WIDTH
    
    rm -f "$services_file"
}

###
# –§—É–Ω–∫—Ü–∏—è: show_logs_menu
# –û–ø–∏—Å–∞–Ω–∏–µ: –ú–µ–Ω—é –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –ª–æ–≥–æ–≤
###
show_logs_menu() {
    local choice=$(dialog --clear \
        --title "–ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤" \
        --menu "–í—ã–±–µ—Ä–∏—Ç–µ –ª–æ–≥:" \
        15 60 7 \
        1 "–°–∏—Å—Ç–µ–º–Ω—ã–π –ª–æ–≥ (syslog)" \
        2 "–õ–æ–≥ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (auth.log)" \
        3 "–õ–æ–≥ —è–¥—Ä–∞ (kern.log)" \
        4 "–õ–æ–≥ Apache/Nginx" \
        5 "–õ–æ–≥ MySQL" \
        6 "–õ–æ–≥ —ç—Ç–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞" \
        0 "–ù–∞–∑–∞–¥" \
        3>&1 1>&2 2>&3)
    
    case $choice in
        1) dialog --textbox /var/log/syslog $DIALOG_HEIGHT $DIALOG_WIDTH ;;
        2) dialog --textbox /var/log/auth.log $DIALOG_HEIGHT $DIALOG_WIDTH ;;
        3) dialog --textbox /var/log/kern.log $DIALOG_HEIGHT $DIALOG_WIDTH ;;
        4) 
            if [ -f /var/log/nginx/error.log ]; then
                dialog --textbox /var/log/nginx/error.log $DIALOG_HEIGHT $DIALOG_WIDTH
            elif [ -f /var/log/apache2/error.log ]; then
                dialog --textbox /var/log/apache2/error.log $DIALOG_HEIGHT $DIALOG_WIDTH
            else
                dialog --msgbox "–õ–æ–≥–∏ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã" 6 40
            fi
            ;;
        5) 
            if [ -f /var/log/mysql/error.log ]; then
                dialog --textbox /var/log/mysql/error.log $DIALOG_HEIGHT $DIALOG_WIDTH
            else
                dialog --msgbox "–õ–æ–≥ MySQL –Ω–µ –Ω–∞–π–¥–µ–Ω" 6 40
            fi
            ;;
        6) dialog --textbox "$LOG_FILE" $DIALOG_HEIGHT $DIALOG_WIDTH ;;
    esac
}

###
# –§—É–Ω–∫—Ü–∏—è: show_iotop
# –û–ø–∏—Å–∞–Ω–∏–µ: –ó–∞–ø—É—Å–∫ iotop (—Ç—Ä–µ–±—É–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏)
###
show_iotop() {
    if command -v iotop &> /dev/null; then
        clear
        iotop
    else
        dialog --title "–û—à–∏–±–∫–∞" \
               --yesno "iotop –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å?" \
               7 40
        if [ $? -eq 0 ]; then
            apt-get install -y iotop
            clear
            iotop
        fi
    fi
}

###
# –§—É–Ω–∫—Ü–∏—è: show_iftop
# –û–ø–∏—Å–∞–Ω–∏–µ: –ó–∞–ø—É—Å–∫ iftop (—Ç—Ä–µ–±—É–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏)
###
show_iftop() {
    if command -v iftop &> /dev/null; then
        clear
        iftop
    else
        dialog --title "–û—à–∏–±–∫–∞" \
               --yesno "iftop –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å?" \
               7 40
        if [ $? -eq 0 ]; then
            apt-get install -y iftop
            clear
            iftop
        fi
    fi
}

################################################################################
# –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–ú–ò (—Å–æ–∫—Ä–∞—â—ë–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è, –ø–æ–ª–Ω–∞—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ñ–∞–π–ª–µ)
################################################################################

###
# –§—É–Ω–∫—Ü–∏—è: init_users_db
# –û–ø–∏—Å–∞–Ω–∏–µ: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (JSON)
###
init_users_db() {
    # –ï—Å–ª–∏ —Ñ–∞–π–ª –ø—É—Å—Ç –∏–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞—ë–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É JSON
    if [[ ! -s "$USERS_FILE" ]]; then
        echo '{"users": []}' > "$USERS_FILE"
        chmod 600 "$USERS_FILE"
        info "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞"
    fi
}

###
# –§—É–Ω–∫—Ü–∏—è: add_user_dialog
# –û–ø–∏—Å–∞–Ω–∏–µ: –î–∏–∞–ª–æ–≥ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
###
add_user_dialog() {
    set_context "users"     # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    
    # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    local username=$(dialog --inputbox "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:" 8 40 3>&1 1>&2 2>&3)
    [[ -z "$username" ]] && return    # –ï—Å–ª–∏ –ø—É—Å—Ç–æ, –≤—ã—Ö–æ–¥–∏–º
    
    # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–∞—Ä–æ–ª—å
    local password=$(dialog --passwordbox "–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å:" 8 40 3>&1 1>&2 2>&3)
    [[ -z "$password" ]] && return
    
    # –í—ã–±–æ—Ä —Ä–æ–ª–∏
    local role=$(dialog --menu "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å:" 12 50 4 \
        "user" "–û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" \
        "admin" "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä" \
        "developer" "–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫" \
        "devops" "DevOps –∏–Ω–∂–µ–Ω–µ—Ä" \
        3>&1 1>&2 2>&3)
    
    # –°–æ–∑–¥–∞—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if id "$username" &>/dev/null; then
        dialog --title "–û—à–∏–±–∫–∞" --msgbox "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å $username —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!" 6 50
        return 1
    fi
    
    # –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    useradd -m -s /bin/bash -c "Created by Deploy Master" "$username"
    echo "$username:$password" | chpasswd
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH
    mkdir -p "/home/$username/.ssh"
    touch "/home/$username/.ssh/authorized_keys"
    chmod 700 "/home/$username/.ssh"
    chmod 600 "/home/$username/.ssh/authorized_keys"
    chown -R "$username:$username" "/home/$username/.ssh"
    
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
    local timestamp=$(date +%s)
    local user_data=$(jq -n \
        --arg user "$username" \
        --arg role "$role" \
        --arg created "$timestamp" \
        '{username: $user, role: $role, created: $created, status: "active"}')
    
    jq ".users += [$user_data]" "$USERS_FILE" > "$USERS_FILE.tmp"
    mv "$USERS_FILE.tmp" "$USERS_FILE"
    
    info "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å $username —Å–æ–∑–¥–∞–Ω"
    dialog --title "–£—Å–ø–µ—Ö" --msgbox "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å $username —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!" 6 50
}

################################################################################
# MC-STYLE –ò–ù–¢–ï–†–§–ï–ô–°
################################################################################

###
# –§—É–Ω–∫—Ü–∏—è: launch_mc_interface
# –û–ø–∏—Å–∞–Ω–∏–µ: –ó–∞–ø—É—Å–∫ MC-style –º–Ω–æ–≥–æ–ø–∞–Ω–µ–ª—å–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ —á–µ—Ä–µ–∑ tmux
###
launch_mc_interface() {
    set_context "mc-style"
    
    info "–ó–∞–ø—É—Å–∫ MC-style –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞..."
    
    # –£–±–∏–≤–∞–µ–º —Å—Ç–∞—Ä—É—é —Å–µ—Å—Å–∏—é –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    tmux kill-session -t deploy-mc 2>/dev/null || true
    
    # –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é tmux —Å–µ—Å—Å–∏—é
    tmux new-session -d -s deploy-mc -n "Deploy-MC"
    
    # –†–∞–∑–¥–µ–ª—è–µ–º –æ–∫–Ω–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ (–≤–µ—Ä—Ö –∏ –Ω–∏–∑)
    tmux split-window -v -t deploy-mc
    
    # –†–∞–∑–¥–µ–ª—è–µ–º –Ω–∏–∂–Ω—é—é –ø–∞–Ω–µ–ª—å –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ (–ª–µ–≤–æ –∏ –ø—Ä–∞–≤–æ)
    tmux split-window -h -t deploy-mc:0.1
    
    # –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å: —Ä–µ–¥–∞–∫—Ç–æ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
    tmux send-keys -t deploy-mc:0.0 "cd /etc && bash" C-m
    
    # –ù–∏–∂–Ω—è—è –ª–µ–≤–∞—è: –ª–æ–≥–∏
    tmux send-keys -t deploy-mc:0.1 "tail -f /var/log/syslog" C-m
    
    # –ù–∏–∂–Ω—è—è –ø—Ä–∞–≤–∞—è: htop
    tmux send-keys -t deploy-mc:0.2 "htop" C-m
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–∫—É—Å –Ω–∞ –≤–µ—Ä—Ö–Ω—é—é –ø–∞–Ω–µ–ª—å
    tmux select-pane -t deploy-mc:0.0
    
    # –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ —Å–µ—Å—Å–∏–∏
    tmux attach-session -t deploy-mc
    
    info "MC-style –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∑–∞–≤–µ—Ä—à—ë–Ω"
}

################################################################################
# HISTOR EXTENSIONS - –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ò–ù–¢–ï–ì–†–ê–¶–ò–ò
################################################################################

###
# –§—É–Ω–∫—Ü–∏—è: iptables_controller_menu
# –û–ø–∏—Å–∞–Ω–∏–µ: –ú–µ–Ω—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è iptables –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–º
###
iptables_controller_menu() {
    while true; do
        local choice=$(dialog --clear \
            --backtitle "$DIALOG_BACKTITLE" \
            --title "IPTABLES –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä (HISTOR)" \
            --menu "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:" \
            $DIALOG_HEIGHT $DIALOG_WIDTH 12 \
            1 "üìã –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ—Ä—Ç–æ–≤" \
            2 "‚úÖ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å" \
            3 "‚ùå –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å" \
            4 "üìä –ü–æ–∫–∞–∑–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞" \
            5 "üîÑ –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å combined –ø—Ä–∞–≤–∏–ª–∞" \
            6 "‚ö° –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ –∫ —Å–∏—Å—Ç–µ–º–µ" \
            7 "üõ†  –°–æ–∑–¥–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å systemd —é–Ω–∏—Ç" \
            8 "üëÄ –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–µ iptables" \
            0 "‚¨ÖÔ∏è  –ù–∞–∑–∞–¥" \
            3>&1 1>&2 2>&3)
        
        case $choice in
            1)
                # –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É –≤ —Ñ–æ–Ω–µ —Å –≤—ã–≤–æ–¥–æ–º –≤ dialog
                bash /root/srv-sys-iptables-controller.sh &> /tmp/iptables_output.txt
                dialog --textbox /tmp/iptables_output.txt 40 100
                ;;
            2)
                local service=$(dialog --inputbox "–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Å–µ—Ä–≤–∏—Å–∞ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏:" 8 50 3>&1 1>&2 2>&3)
                if [[ -n "$service" ]]; then
                    cd /root && bash srv-sys-iptables-controller.sh activate "$service" 2>&1 | tee /tmp/iptables_output.txt
                    dialog --textbox /tmp/iptables_output.txt 20 80
                fi
                ;;
            3)
                local service=$(dialog --inputbox "–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Å–µ—Ä–≤–∏—Å–∞ –¥–ª—è –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏:" 8 50 3>&1 1>&2 2>&3)
                if [[ -n "$service" ]]; then
                    cd /root && bash srv-sys-iptables-controller.sh deactivate "$service" 2>&1 | tee /tmp/iptables_output.txt
                    dialog --textbox /tmp/iptables_output.txt 20 80
                fi
                ;;
            4)
                iptables -L -n -v --line-numbers > /tmp/iptables_rules.txt
                dialog --textbox /tmp/iptables_rules.txt 40 100
                ;;
            5)
                cd /root && bash srv-sys-iptables-controller.sh combine 2>&1 | tee /tmp/iptables_output.txt
                dialog --msgbox "$(cat /tmp/iptables_output.txt)" 20 80
                ;;
            6)
                cd /root && bash srv-sys-iptables-controller.sh apply 2>&1 | tee /tmp/iptables_output.txt
                dialog --msgbox "$(cat /tmp/iptables_output.txt)" 20 80
                ;;
            7)
                cd /root && bash srv-sys-iptables-controller.sh create-service 2>&1 | tee /tmp/iptables_output.txt
                dialog --msgbox "$(cat /tmp/iptables_output.txt)" 20 80
                ;;
            8)
                iptables -L -n -v --line-numbers > /tmp/iptables_current.txt
                dialog --textbox /tmp/iptables_current.txt 40 100
                ;;
            0|"")
                return
                ;;
        esac
    done
}

###
# –§—É–Ω–∫—Ü–∏—è: ssh_sessions_monitoring_menu
# –û–ø–∏—Å–∞–Ω–∏–µ: –ú–µ–Ω—é –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ SSH-—Å–µ—Å—Å–∏–π (SID —Å–∏—Å—Ç–µ–º–∞)
###
ssh_sessions_monitoring_menu() {
    while true; do
        local choice=$(dialog --clear \
            --backtitle "$DIALOG_BACKTITLE" \
            --title "SSH –°–µ—Å—Å–∏–∏ - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (SID)" \
            --menu "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:" \
            $DIALOG_HEIGHT $DIALOG_WIDTH 10 \
            1 "üìã –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π" \
            2 "üîç –î–µ—Ç–∞–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å–µ—Å—Å–∏–∏" \
            3 "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—Å–µ—Ö —Å–µ—Å—Å–∏–π" \
            4 "üîê –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å PAM —Ö—É–∫–∏" \
            5 "üìÇ –ü—Ä–æ—Å–º–æ—Ç—Ä –∞—Ä—Ö–∏–≤–∞ —Å–µ—Å—Å–∏–π" \
            0 "‚¨ÖÔ∏è  –ù–∞–∑–∞–¥" \
            3>&1 1>&2 2>&3)
        
        case $choice in
            1)
                bash /root/ssh-sid-system.sh list > /tmp/sessions_list.txt
                dialog --textbox /tmp/sessions_list.txt 30 90
                ;;
            2)
                local sid=$(dialog --inputbox "–í–≤–µ–¥–∏—Ç–µ SID —Å–µ—Å—Å–∏–∏:" 8 60 3>&1 1>&2 2>&3)
                if [[ -n "$sid" ]]; then
                    bash /root/ssh-sid-system.sh show "$sid" > /tmp/session_detail.txt
                    dialog --textbox /tmp/session_detail.txt 40 100
                fi
                ;;
            3)
                # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                local active=$(ls /srv/sys/ssh/ssh_session/active/*.log 2>/dev/null | wc -l)
                local archived=$(ls /srv/sys/ssh/ssh_session/archive/*.log 2>/dev/null | wc -l)
                local total=$((active + archived))
                
                dialog --msgbox "–°–¢–ê–¢–ò–°–¢–ò–ö–ê SSH-–°–ï–°–°–ò–ô:\n\n–ê–∫—Ç–∏–≤–Ω—ã—Ö: $active\n–ê—Ä—Ö–∏–≤–Ω—ã—Ö: $archived\n–í—Å–µ–≥–æ: $total" 12 50
                ;;
            4)
                bash /root/ssh-sid-system.sh install-pam 2>&1 | tee /tmp/pam_install.txt
                dialog --textbox /tmp/pam_install.txt 20 80
                ;;
            5)
                ls -lh /srv/sys/ssh/ssh_session/archive/ > /tmp/archive_list.txt
                dialog --textbox /tmp/archive_list.txt 30 100
                ;;
            0|"")
                return
                ;;
        esac
    done
}

###
# –§—É–Ω–∫—Ü–∏—è: win_config_management_menu
# –û–ø–∏—Å–∞–Ω–∏–µ: –ú–µ–Ω—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Win_Config –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–µ–π
###
win_config_management_menu() {
    while true; do
        local choice=$(dialog --clear \
            --backtitle "$DIALOG_BACKTITLE" \
            --title "Win_Config –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è" \
            --menu "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:" \
            $DIALOG_HEIGHT $DIALOG_WIDTH 10 \
            1 "üéØ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã" \
            2 "üö™ –î–æ–±–∞–≤–∏—Ç—å gate-—Å–µ—Ä–≤–µ—Ä" \
            3 "üë§ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" \
            4 "üìã –°–ø–∏—Å–æ–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π" \
            5 "üì§ –≠–∫—Å–ø–æ—Ä—Ç –∫–æ–Ω—Ñ–∏–≥–∞ –¥–ª—è Windows" \
            6 "üóë  –£–¥–∞–ª–∏—Ç—å —Ö–æ—Å—Ç –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞" \
            0 "‚¨ÖÔ∏è  –ù–∞–∑–∞–¥" \
            3>&1 1>&2 2>&3)
        
        case $choice in
            1)
                bash /root/win-config-automation.sh init 2>&1 | tee /tmp/winconfig_output.txt
                dialog --msgbox "$(cat /tmp/winconfig_output.txt)" 15 70
                ;;
            2)
                local gate_ip=$(dialog --inputbox "IP gate-—Å–µ—Ä–≤–µ—Ä–∞:" 8 50 3>&1 1>&2 2>&3)
                [[ -z "$gate_ip" ]] && continue
                
                local gate_port=$(dialog --inputbox "SSH –ø–æ—Ä—Ç gate (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 22):" 8 50 "22" 3>&1 1>&2 2>&3)
                local gate_user=$(dialog --inputbox "–ò–º—è gate-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é gate):" 8 50 "gate" 3>&1 1>&2 2>&3)
                
                bash /root/win-config-automation.sh add-gate "$gate_ip" "$gate_port" "$gate_user" 2>&1 | tee /tmp/winconfig_output.txt
                dialog --msgbox "$(cat /tmp/winconfig_output.txt)" 15 70
                ;;
            3)
                local username=$(dialog --inputbox "–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:" 8 50 3>&1 1>&2 2>&3)
                [[ -z "$username" ]] && continue
                
                local hostname=$(dialog --inputbox "Hostname –¥–ª—è SSH (–Ω–∞–ø—Ä–∏–º–µ—Ä: myserver):" 8 50 3>&1 1>&2 2>&3)
                [[ -z "$hostname" ]] && continue
                
                local server_ip=$(dialog --inputbox "IP —Å–µ—Ä–≤–µ—Ä–∞:" 8 50 3>&1 1>&2 2>&3)
                [[ -z "$server_ip" ]] && continue
                
                local ssh_port=$(dialog --inputbox "SSH –ø–æ—Ä—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 22):" 8 50 "22" 3>&1 1>&2 2>&3)
                
                local use_proxy=$(dialog --yesno "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ProxyJump —á–µ—Ä–µ–∑ gate?" 7 50 3>&1 1>&2 2>&3)
                local proxy_flag="true"
                [[ $? -ne 0 ]] && proxy_flag="false"
                
                bash /root/win-config-automation.sh add-user "$username" "$hostname" "$server_ip" "$ssh_port" "$proxy_flag" 2>&1 | tee /tmp/winconfig_output.txt
                dialog --msgbox "$(cat /tmp/winconfig_output.txt)" 20 80
                ;;
            4)
                bash /root/win-config-automation.sh list > /tmp/winconfig_list.txt
                dialog --textbox /tmp/winconfig_list.txt 30 90
                ;;
            5)
                bash /root/win-config-automation.sh export 2>&1 | tee /tmp/winconfig_export.txt
                dialog --textbox /tmp/winconfig_export.txt 20 80
                ;;
            6)
                local hostname=$(dialog --inputbox "Hostname –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:" 8 50 3>&1 1>&2 2>&3)
                if [[ -n "$hostname" ]]; then
                    dialog --yesno "–£–¥–∞–ª–∏—Ç—å —Ö–æ—Å—Ç '$hostname' –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞?" 7 50
                    if [[ $? -eq 0 ]]; then
                        bash /root/win-config-automation.sh remove "$hostname" 2>&1 | tee /tmp/winconfig_output.txt
                        dialog --msgbox "$(cat /tmp/winconfig_output.txt)" 15 70
                    fi
                fi
                ;;
            0|"")
                return
                ;;
        esac
    done
}

################################################################################
# –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ
################################################################################

###
# –§—É–Ω–∫—Ü–∏—è: main_dialog_menu
# –û–ø–∏—Å–∞–Ω–∏–µ: –£–ª—É—á—à–µ–Ω–Ω–æ–µ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ –∏ –±—ã—Å—Ç—Ä—ã–º –¥–æ—Å—Ç—É–ø–æ–º
###
main_dialog_menu() {
    set_context "main"      # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
    
    while true; do
        # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
        local choice=$(dialog --clear \
            --backtitle "$DIALOG_BACKTITLE" \
            --title "‚ïî‚ïê‚ïê‚ïê‚ïê –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é - v5.0 Enhanced + HISTOR + SRV-SYS ‚ïê‚ïê‚ïê‚ïê‚ïó" \
            --menu "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:" \
            $DIALOG_HEIGHT $DIALOG_WIDTH 24 \
            "" "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ –ë–´–°–¢–†–´–ï –î–ï–ô–°–¢–í–ò–Ø ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" \
            Q "‚ö° –ë—ã—Å—Ç—Ä–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞" \
            W "üåê –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ (NEW!)" \
            U "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∏ —è–¥—Ä–∞ (NEW!)" \
            "" "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ –£–°–¢–ê–ù–û–í–ö–ê –°–ï–†–í–ò–°–û–í ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" \
            2 "‚öôÔ∏è  –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤" \
            D "üõ†  Dev-–æ–∫—Ä—É–∂–µ–Ω–∏–µ (C/Python)" \
            V "üíª VSCode Server (IDE –≤ –±—Ä–∞—É–∑–µ—Ä–µ)" \
            8 "üê≥ Docker —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ" \
            9 "üóÑ  –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö" \
            10 "üì¶ –¢–µ—Å—Ç–æ–≤–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–æ–º" \
            "" "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ –ê–î–ú–ò–ù–ò–°–¢–†–ò–†–û–í–ê–ù–ò–ï ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" \
            N "üåê –õ–æ–∫–∞–ª—å–Ω—ã–π DNS (dnsmasq)" \
            1 "üë§ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏" \
            5 "üíæ –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ" \
            6 "üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å" \
            7 "üöÄ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å" \
            P "‚ö° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (v8 Performance)" \
            "" "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ –ú–û–ù–ò–¢–û–†–ò–ù–ì ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" \
            3 "üñ•  MC-Style –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å" \
            4 "üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã" \
            "" "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ HISTOR –†–ê–°–®–ò–†–ï–ù–ò–Ø ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" \
            11 "üî• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ iptables (HISTOR)" \
            12 "üîê –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ SSH-—Å–µ—Å—Å–∏–π (SID)" \
            13 "‚öôÔ∏è  Win_Config –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è" \
            "" "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" \
            X "üóëÔ∏è  –£–¥–∞–ª–µ–Ω–∏–µ –º–æ–¥—É–ª–µ–π" \
            H "üìñ –°–ø—Ä–∞–≤–∫–∞ [F1]" \
            I "‚ÑπÔ∏è  –û —Å–∏—Å—Ç–µ–º–µ" \
            0 "‚ùå –í—ã—Ö–æ–¥" \
            3>&1 1>&2 2>&3)
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        case $choice in
            Q|q)
                set_context "quick-setup"
                quick_setup_wizard
                ;;
            W|w)
                set_context "web-deploy"
                # –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥—É–ª—å –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞
                if source "$(dirname $0)/web-deploy-advanced.sh" 2>/dev/null; then
                    web_deploy_menu
                else
                    dialog --msgbox "–ú–æ–¥—É–ª—å web-deploy-advanced.sh –Ω–µ –Ω–∞–π–¥–µ–Ω!" 8 50
                fi
                ;;
            U|u)
                set_context "system-update"
                # –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥—É–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                if source "$(dirname $0)/system-update-manager.sh" 2>/dev/null; then
                    update_menu
                else
                    dialog --msgbox "–ú–æ–¥—É–ª—å system-update-manager.sh –Ω–µ –Ω–∞–π–¥–µ–Ω!" 8 50
                fi
                ;;
            D|d)
                set_context "dev-environment"
                if source "$(dirname $0)/dev-environment-setup.sh" 2>/dev/null; then
                    dev_menu
                else
                    dialog --msgbox "–ú–æ–¥—É–ª—å dev-environment-setup.sh –Ω–µ –Ω–∞–π–¥–µ–Ω!" 8 50
                fi
                ;;
            V|v)
                set_context "vscode-server"
                if source "$(dirname $0)/vscode-server-setup.sh" 2>/dev/null; then
                    vscode_menu
                else
                    dialog --msgbox "–ú–æ–¥—É–ª—å vscode-server-setup.sh –Ω–µ –Ω–∞–π–¥–µ–Ω!" 8 50
                fi
                ;;
            1) 
                set_context "users"
                # user_management_menu    # –í—ã–∑–æ–≤ –º–µ–Ω—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
                add_user_dialog           # –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –≤—ã–∑—ã–≤–∞–µ–º —É–ø—Ä–æ—â—ë–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é
                ;;
            2) 
                set_context "services"
                services_installation_menu
                ;;
            3) 
                set_context "mc-style"
                launch_mc_interface
                ;;
            4) 
                set_context "monitoring"
                monitoring_menu
                ;;
            5) 
                # backup_restore_menu
                dialog --msgbox "–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ" 6 40
                ;;
            6) 
                # security_menu
                dialog --msgbox "–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ" 6 40
                ;;
            7) 
                # performance_menu
                dialog --msgbox "–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ" 6 40
                ;;
            P|p)
                set_context "performance-optimizer"
                if source "$(dirname $0)/performance-optimizer.sh" 2>/dev/null; then
                    optimization_menu
                else
                    dialog --msgbox "–ú–æ–¥—É–ª—å performance-optimizer.sh –Ω–µ –Ω–∞–π–¥–µ–Ω!" 8 50
                fi
                ;;
            N|n)
                set_context "local-dns"
                if source "$(dirname $0)/local-dns-manager.sh" 2>/dev/null; then
                    dns_menu
                else
                    dialog --msgbox "–ú–æ–¥—É–ª—å local-dns-manager.sh –Ω–µ –Ω–∞–π–¥–µ–Ω!" 8 50
                fi
                ;;
            8) 
                # docker_menu
                dialog --msgbox "–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ" 6 40
                ;;
            9) 
                # database_menu
                dialog --msgbox "–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ" 6 40
                ;;
            10)
                set_context "installation"
                # –¢–µ—Å—Ç–æ–≤–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–æ–º
                parallel_install_with_progress "nginx" "mysql" "postgresql" "redis" "docker"
                ;;
            11)
                set_context "iptables"
                # –ó–∞–ø—É—Å–∫ iptables –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
                iptables_controller_menu
                ;;
            12)
                set_context "ssh-sessions"
                # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ SSH-—Å–µ—Å—Å–∏–π —á–µ—Ä–µ–∑ SID —Å–∏—Å—Ç–µ–º—É
                ssh_sessions_monitoring_menu
                ;;
            13)
                set_context "win-config"
                # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ win_config
                win_config_management_menu
                ;;
            X|x)
                set_context "uninstaller"
                if source "$(dirname $0)/module-uninstaller.sh" 2>/dev/null; then
                    uninstaller_menu
                else
                    dialog --msgbox "–ú–æ–¥—É–ª—å module-uninstaller.sh –Ω–µ –Ω–∞–π–¥–µ–Ω!" 8 50
                fi
                ;;
            I|i)
                # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ
                show_system_info
                ;;
            H|h)
                show_context_help "$CURRENT_CONTEXT"
                ;;
            0|"")
                # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã—Ö–æ–¥–∞
                dialog --yesno "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?" 7 40
                if [ $? -eq 0 ]; then
                    clear
                    echo "–í—ã—Ö–æ–¥ –∏–∑ Deploy Master v5.0"
                    exit 0
                fi
                ;;
        esac
    done
}

################################################################################
# –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
################################################################################

###
# –§—É–Ω–∫—Ü–∏—è: show_system_info
# –û–ø–∏—Å–∞–Ω–∏–µ: –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∏—Å—Ç–µ–º–µ
###
show_system_info() {
    local info_text=$(cat <<INFO
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë               –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –°–ò–°–¢–ï–ú–ï                         ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£

üìä –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞:
   $(lsb_release -d | cut -f2-)

üêß –Ø–¥—Ä–æ:
   $(uname -r)

üñ•  –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:
   $(uname -m)

‚è±  –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:
   $(uptime -p)

üíª –ü—Ä–æ—Ü–µ—Å—Å–æ—Ä:
   $(lscpu | grep 'Model name' | cut -d':' -f2 | xargs)
   –Ø–¥–µ—Ä: $(nproc)

üíæ –ü–∞–º—è—Ç—å:
   $(free -h | awk '/^Mem:/ {print "–í—Å–µ–≥–æ: " \$2 ", –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: " \$3 ", –°–≤–æ–±–æ–¥–Ω–æ: " \$4}')

üìÅ –î–∏—Å–∫ (–∫–æ—Ä–Ω–µ–≤–æ–π —Ä–∞–∑–¥–µ–ª):
   $(df -h / | awk 'NR==2 {print "–í—Å–µ–≥–æ: " \$2 ", –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: " \$3 " (" \$5 "), –°–≤–æ–±–æ–¥–Ω–æ: " \$4}')

üåê IP –∞–¥—Ä–µ—Å:
   $(hostname -I | awk '{print \$1}')

üîß –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø–∞–∫–µ—Ç–æ–≤:
   $(dpkg --list | grep ^ii | wc -l)

üì¶ –î–æ—Å—Ç—É–ø–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π:
   $(apt list --upgradable 2>/dev/null | grep -c upgradable || echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Ä—É—á–Ω—É—é")

‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
INFO
)

    dialog --title "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ" \
        --msgbox "$info_text" 30 70
}

###
# –§—É–Ω–∫—Ü–∏—è: quick_setup_wizard
# –û–ø–∏—Å–∞–Ω–∏–µ: –ë—ã—Å—Ç—Ä—ã–π –º–∞—Å—Ç–µ—Ä –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –Ω–æ–≤—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤
###
quick_setup_wizard() {
    dialog --title "–ë—ã—Å—Ç—Ä–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞" \
        --yesno "–ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∞—Å—Ç–µ—Ä –±—ã—Å—Ç—Ä–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏?\n\n–ë—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–æ:\n‚Ä¢ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã\n‚Ä¢ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∞–∑–æ–≤—ã—Ö –ø–∞–∫–µ—Ç–æ–≤\n‚Ä¢ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏\n‚Ä¢ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ firewall" 14 60 || return
    
    (
        echo "10"
        echo "# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–≤ –ø–∞–∫–µ—Ç–æ–≤..."
        apt-get update -qq 2>&1 | tail -5
        
        echo "30"
        echo "# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∞–∑–æ–≤—ã—Ö —É—Ç–∏–ª–∏—Ç..."
        apt-get install -y curl wget git htop vim nano net-tools 2>&1 | tail -5
        
        echo "50"
        echo "# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ firewall (iptables)..."
        # –†–∞–∑—Ä–µ—à–∞–µ–º SSH, –µ—Å–ª–∏ –ø—Ä–∞–≤–∏–ª–æ –µ—â—ë –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        if ! iptables -C INPUT -p tcp --dport 22 -j ACCEPT 2>/dev/null; then
            iptables -I INPUT -p tcp --dport 22 -j ACCEPT
        fi
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∞–≤–∏–ª–∞, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω iptables-save
        if command -v iptables-save >/dev/null 2>&1; then
            mkdir -p /etc/iptables
            iptables-save > /etc/iptables/rules.v4 2>/dev/null || true
        fi
        
        echo "70"
        echo "# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH..."
        sed -i 's/#PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config 2>&1 || true
        
        echo "90"
        echo "# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫..."
        systemctl restart sshd 2>&1 || true
        
        echo "100"
        echo "# –ì–æ—Ç–æ–≤–æ!"
        sleep 1
    ) | dialog --gauge "–ë—ã—Å—Ç—Ä–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞..." 10 70 0
    
    dialog --msgbox "‚úÖ –ë—ã—Å—Ç—Ä–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n\n–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ." 10 50
}

################################################################################
# –£–°–¢–ê–ù–û–í–ö–ê –°–ï–†–í–ò–°–û–í (–∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–æ–≤)
################################################################################

###
# –§—É–Ω–∫—Ü–∏—è: services_installation_menu
# –û–ø–∏—Å–∞–Ω–∏–µ: –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏
###
services_installation_menu() {
    set_context "services"
    
    # –ß–µ–∫–±–æ–∫—Å –¥–ª—è –≤—ã–±–æ—Ä–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
    local choices=$(dialog --separate-output \
        --backtitle "$DIALOG_BACKTITLE" \
        --title "–í—ã–±–æ—Ä –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏" \
        --checklist "–û—Ç–º–µ—Ç—å—Ç–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (Space - –≤—ã–±–æ—Ä, Enter - –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å):" \
        20 70 10 \
        "nginx" "–í–µ–±-—Å–µ—Ä–≤–µ—Ä Nginx" off \
        "apache" "–í–µ–±-—Å–µ—Ä–≤–µ—Ä Apache" off \
        "mysql" "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö MySQL" off \
        "postgresql" "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö PostgreSQL" off \
        "mongodb" "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö MongoDB" off \
        "redis" "–ö—ç—à-—Å–µ—Ä–≤–µ—Ä Redis" off \
        "docker" "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è Docker" off \
        "nodejs" "Node.js runtime" off \
        "python" "Python 3" off \
        "php" "PHP –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä" off \
        3>&1 1>&2 2>&3)
    
    # –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è
    [[ -z "$choices" ]] && return
    
    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤—ã–±–æ—Ä –≤ –º–∞—Å—Å–∏–≤
    local components=()
    while IFS= read -r line; do
        components+=("$line")
    done <<< "$choices"
    
    # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
    dialog --yesno "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å ${#components[@]} –∫–æ–º–ø–æ–Ω–µ–Ω—Ç(–æ–≤)?" 7 50
    if [ $? -eq 0 ]; then
        # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—É—é —É—Å—Ç–∞–Ω–æ–≤–∫—É —Å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–æ–º
        parallel_install_with_progress "${components[@]}"
    fi
}

################################################################################
# –¢–û–ß–ö–ê –í–•–û–î–ê (MAIN)
################################################################################

###
# –§—É–Ω–∫—Ü–∏—è: main
# –û–ø–∏—Å–∞–Ω–∏–µ: –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è - —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤ –ø—Ä–æ–≥—Ä–∞–º–º—É
###
main() {
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ root (–Ω–µ–æ–±—Ö–æ–¥–∏–º—ã –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –æ–ø–µ—Ä–∞—Ü–∏–π)
    if [ "$EUID" -ne 0 ]; then
        echo "‚ùå –û—à–∏–±–∫–∞: –°–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –æ—Ç root"
        echo "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: sudo $0"
        exit 1
    fi
    
    # –û—á–∏—Å—Ç–∫–∞ —ç–∫—Ä–∞–Ω–∞ –∏ –≤—ã–≤–æ–¥ –±–∞–Ω–Ω–µ—Ä–∞
    clear
    banner
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã
    init_system
    
    # –ó–∞–ø—É—Å–∫ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
    main_dialog_menu
}

# –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã
main "$@"
