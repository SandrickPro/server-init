#!/bin/bash
################################################################################
# ะกะบัะธะฟั ะฝะฐัััะพะนะบะธ SSH-ะฑะตะทะพะฟะฐัะฝะพััะธ ะธ MOTD
# ะฆะตะปั: ะะฐัััะพะนะบะฐ ะฑะตะทะพะฟะฐัะฝะพะณะพ SSH-ะดะพัััะฟะฐ ัะตัะตะท gate-ะฟะพะปัะทะพะฒะฐัะตะปั,
#       ะพัะบะปััะตะฝะธะต root, ะฝะฐัััะพะนะบะฐ MOTD ะธ ะฑะฐะฝะฝะตัะฐ
# ะะฒัะพั: Sandrick Tech
# ะะตััะธั: 1.0
################################################################################

# ะัะพะฒะตัะบะฐ ะทะฐะฟััะบะฐ ะพั root
# ะะตัะตะผะตะฝะฝะฐั $EUID ัะพะดะตัะถะธั ัััะตะบัะธะฒะฝัะน ID ะฟะพะปัะทะพะฒะฐัะตะปั (root = 0)
if [ "$EUID" -ne 0 ]; then 
    echo "โ ะัะธะฑะบะฐ: ะกะบัะธะฟั ะดะพะปะถะตะฝ ะฑััั ะทะฐะฟััะตะฝ ั ะฟัะฐะฒะฐะผะธ root"
    echo "ะัะฟะพะปัะทัะนัะต: sudo $0"
    exit 1
fi

################################################################################
# ะคัะฝะบัะธั: ะะฐัััะพะนะบะฐ MOTD (Message of the Day)
# ะะฟะธัะฐะฝะธะต: ะัะธัะฐะตั ััะฐะฝะดะฐััะฝัะต MOTD-ัะบัะธะฟัั Ubuntu/Debian,
#           ะพััะฐะฒะปัะตั ัะพะปัะบะพ ัะธััะตะผะฝัะต ะธ ะดะพะฑะฐะฒะปัะตั ะบะฐััะพะผะฝัะน ะฑะฐะฝะฝะตั
################################################################################
setup_motd() {
    echo "๐จ ะะฐัััะพะนะบะฐ MOTD (Message of the Day)..."
    
    # ะกะพะทะดะฐัะผ ัะตะทะตัะฒะฝัั ะบะพะฟะธั ะดะธัะตะบัะพัะธะธ MOTD ะฝะฐ ัะปััะฐะน ะฝะตะพะฑัะพะดะธะผะพััะธ ะพัะบะฐัะฐ
    # ะะฟัะธั -p: ัะพะทะดะฐัั ัะพะดะธัะตะปััะบะธะต ะดะธัะตะบัะพัะธะธ, ะตัะปะธ ะพะฝะธ ะฝะต ัััะตััะฒััั
    if [ -d /etc/update-motd.d ]; then
        echo "  ๐ ะกะพะทะดะฐะฝะธะต ัะตะทะตัะฒะฝะพะน ะบะพะฟะธะธ /etc/update-motd.d..."
        mkdir -p /root/backups/motd
        # ะะฟัะธั -a: ะฐััะธะฒะฝัะน ัะตะถะธะผ (ัะพััะฐะฝัะตั ะฟัะฐะฒะฐ, ะฒะปะฐะดะตะปััะฐ, ะฒัะตะผั)
        cp -a /etc/update-motd.d /root/backups/motd/motd_backup_$(date +%Y%m%d_%H%M%S)
    fi
    
    # ะัะบะปััะฐะตะผ ััะฐะฝะดะฐััะฝัะต MOTD-ัะบัะธะฟัั Ubuntu
    # ะญัะธ ัะบัะธะฟัั ะฒัะฒะพะดัั ะธะฝัะพัะผะฐัะธั ะพ ะฝะพะฒะพัััั, ะพะฑะฝะพะฒะปะตะฝะธัั ะธ ัะตะบะปะฐะผะต
    echo "  ๐๏ธ  ะัะบะปััะตะฝะธะต ััะฐะฝะดะฐััะฝัั MOTD-ัะบัะธะฟัะพะฒ..."
    
    # ะะตัะตะฑะธัะฐะตะผ ัะฟะธัะพะบ ะฝะตะฝัะถะฝัั ัะบัะธะฟัะพะฒ
    for script in 10-help-text 50-motd-news 80-livepatch 88-esm-announce 91-contract-ua-esm-status 95-hwe-eol; do
        # ะัะพะฒะตััะตะผ ัััะตััะฒะพะฒะฐะฝะธะต ัะฐะนะปะฐ
        if [ -f "/etc/update-motd.d/$script" ]; then
            echo "    - ะัะบะปััะตะฝะธะต $script"
            # ะฃะฑะธัะฐะตะผ ะฟัะฐะฒะฐ ะฝะฐ ะฒัะฟะพะปะฝะตะฝะธะต (ัะบัะธะฟั ะฟะตัะตััะฐะฝะตั ะทะฐะฟััะบะฐัััั)
            chmod -x "/etc/update-motd.d/$script"
        fi
    done
    
    # ะัะบะปััะฐะตะผ ะฝะพะฒะพััะธ MOTD ะฟะพะปะฝะพัััั ัะตัะตะท ะบะพะฝัะธะณััะฐัะธะพะฝะฝัะน ัะฐะนะป
    echo "  ๐ฐ ะัะบะปััะตะฝะธะต MOTD news..."
    # ะะฟัะธั -i: ัะตะดะฐะบัะธัะพะฒะฐัั ัะฐะนะป ะฝะฐ ะผะตััะต
    # s/ENABLED=1/ENABLED=0/: ะทะฐะผะตะฝัะตั ENABLED=1 ะฝะฐ ENABLED=0
    sed -i 's/ENABLED=1/ENABLED=0/' /etc/default/motd-news 2>/dev/null
    
    # ะะพะฟะธััะตะผ ะฝะฐั ะบะฐััะพะผะฝัะน ะฑะฐะฝะฝะตั SSH
    echo "  ๐จ ะฃััะฐะฝะพะฒะบะฐ ะบะฐััะพะผะฝะพะณะพ SSH-ะฑะฐะฝะฝะตัะฐ..."
    # ะัะพะฒะตััะตะผ ัััะตััะฒะพะฒะฐะฝะธะต ัะฐะนะปะฐ ะฑะฐะฝะฝะตัะฐ
    if [ -f "ssh-banner.sh" ]; then
        # ะะพะฟะธััะตะผ ะฒ /etc/profile.d/ - ัะบัะธะฟัั ะธะท ััะพะน ะดะธัะตะบัะพัะธะธ
        # ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฒัะฟะพะปะฝััััั ะฟัะธ ะฒัะพะดะต ะฒ ัะธััะตะผั
        cp ssh-banner.sh /etc/profile.d/
        # ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฟัะฐะฒะฐ: ะฒะปะฐะดะตะปะตั root, ะณััะฟะฟะฐ root, ะฟัะฐะฒะฐ 755 (rwxr-xr-x)
        chmod 755 /etc/profile.d/ssh-banner.sh
        echo "  โ ะะฐะฝะฝะตั ัััะฐะฝะพะฒะปะตะฝ ะฒ /etc/profile.d/ssh-banner.sh"
    else
        echo "  โ๏ธ  ะัะตะดัะฟัะตะถะดะตะฝะธะต: ะคะฐะนะป ssh-banner.sh ะฝะต ะฝะฐะนะดะตะฝ"
    fi
    
    # ะัะบะปััะฐะตะผ ััะฐะฝะดะฐััะฝัะน MOTD ะฟะพะปะฝะพัััั
    echo "  ๐ ะัะบะปััะตะฝะธะต ััะฐะฝะดะฐััะฝะพะณะพ MOTD..."
    # ะกะพะทะดะฐัะผ ะฟัััะพะน ัะฐะนะป /etc/motd (ััะฐะฝะดะฐััะฝัะน ัะตะบััะพะฒัะน MOTD)
    : > /etc/motd
    
    echo "  โ MOTD ะฝะฐัััะพะตะฝ ััะฟะตัะฝะพ"
}

################################################################################
# ะคัะฝะบัะธั: ะกะพะทะดะฐะฝะธะต gate-ะฟะพะปัะทะพะฒะฐัะตะปั
# ะะฟะธัะฐะฝะธะต: ะกะพะทะดะฐัั ัะฟะตัะธะฐะปัะฝะพะณะพ ะฟะพะปัะทะพะฒะฐัะตะปั "gate" ะดะปั SSH-ะดะพัััะฟะฐ,
#           ัะตัะตะท ะบะพัะพัะพะณะพ ะพัััะตััะฒะปัะตััั ProxyJump ะบ ะดััะณะธะผ ะฟะพะปัะทะพะฒะฐัะตะปัะผ
################################################################################
create_gate_user() {
    echo "๐ช ะกะพะทะดะฐะฝะธะต gate-ะฟะพะปัะทะพะฒะฐัะตะปั..."
    
    # ะัะพะฒะตััะตะผ, ะฝะต ัััะตััะฒัะตั ะปะธ ัะถะต ะฟะพะปัะทะพะฒะฐัะตะปั gate
    # id -u: ะฒัะฒะพะดะธั UID ะฟะพะปัะทะพะฒะฐัะตะปั, ะตัะปะธ ะพะฝ ัััะตััะฒัะตั
    # 2>/dev/null: ะฟะพะดะฐะฒะปัะตะผ ะฒัะฒะพะด ะพัะธะฑะพะบ
    if id -u gate >/dev/null 2>&1; then
        echo "  โ๏ธ  ะะพะปัะทะพะฒะฐัะตะปั gate ัะถะต ัััะตััะฒัะตั"
        return 0
    fi
    
    # ะกะพะทะดะฐัะผ ัะธััะตะผะฝะพะณะพ ะฟะพะปัะทะพะฒะฐัะตะปั gate
    # --system: ัะพะทะดะฐัั ัะธััะตะผะฝะพะณะพ ะฟะพะปัะทะพะฒะฐัะตะปั (UID < 1000)
    # --shell /bin/bash: ะฝะฐะทะฝะฐัะธัั bash ะฒ ะบะฐัะตััะฒะต shell
    # --home-dir /home/gate: ัะบะฐะทะฐัั ะดะพะผะฐัะฝัั ะดะธัะตะบัะพัะธั
    # --create-home: ัะพะทะดะฐัั ะดะพะผะฐัะฝัั ะดะธัะตะบัะพัะธั
    # --comment: ะพะฟะธัะฐะฝะธะต ััััะฝะพะน ะทะฐะฟะธัะธ
    useradd --system --shell /bin/bash --home-dir /home/gate \
            --create-home --comment "SSH Gateway User" gate
    
    # ะัะพะฒะตัะบะฐ ััะฟะตัะฝะพััะธ ัะพะทะดะฐะฝะธั ะฟะพะปัะทะพะฒะฐัะตะปั
    if [ $? -eq 0 ]; then
        echo "  โ ะะพะปัะทะพะฒะฐัะตะปั gate ัะพะทะดะฐะฝ"
    else
        echo "  โ ะัะธะฑะบะฐ ัะพะทะดะฐะฝะธั ะฟะพะปัะทะพะฒะฐัะตะปั gate"
        return 1
    fi
    
    # ะกะพะทะดะฐัะผ ะดะธัะตะบัะพัะธั ะดะปั SSH-ะบะปััะตะน
    echo "  ๐ ะะฐัััะพะนะบะฐ SSH-ะบะปััะตะน ะดะปั gate..."
    # ะะฟัะธั -p: ัะพะทะดะฐัั ะฒัะต ัะพะดะธัะตะปััะบะธะต ะดะธัะตะบัะพัะธะธ
    mkdir -p /home/gate/.ssh
    
    # ะกะพะทะดะฐัะผ ัะฐะนะป authorized_keys ะดะปั SSH-ะบะปััะตะน
    # ะ ััะพั ัะฐะนะป ะฝัะถะฝะพ ะดะพะฑะฐะฒะธัั ะฟัะฑะปะธัะฝัะต ะบะปััะธ ะฟะพะปัะทะพะฒะฐัะตะปะตะน
    touch /home/gate/.ssh/authorized_keys
    
    # ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฟัะฐะฒะธะปัะฝัะต ะฟัะฐะฒะฐ ะดะพัััะฟะฐ (ะฒะฐะถะฝะพ ะดะปั ะฑะตะทะพะฟะฐัะฝะพััะธ SSH!)
    # .ssh ะดะพะปะถะฝะฐ ะธะผะตัั ะฟัะฐะฒะฐ 700 (rwx------)
    chmod 700 /home/gate/.ssh
    # authorized_keys ะดะพะปะถะตะฝ ะธะผะตัั ะฟัะฐะฒะฐ 600 (rw-------)
    chmod 600 /home/gate/.ssh/authorized_keys
    # ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฒะปะฐะดะตะปััะฐ ะดะธัะตะบัะพัะธะธ ะธ ัะฐะนะปะพะฒ
    chown -R gate:gate /home/gate/.ssh
    
    # ะกะพะทะดะฐัะผ ะบะพะฝัะธะณััะฐัะธะพะฝะฝัะน ัะฐะนะป SSH ะดะปั gate-ะฟะพะปัะทะพะฒะฐัะตะปั
    echo "  โ๏ธ  ะกะพะทะดะฐะฝะธะต SSH-ะบะพะฝัะธะณััะฐัะธะธ ะดะปั gate..."
    
    # ะกะพะทะดะฐัะผ ัะฐะนะป config ั ะฝะฐัััะพะนะบะฐะผะธ ะดะปั ProxyJump
    cat > /home/gate/.ssh/config << 'EOF'
# SSH Configuration for Gate User
# ะญัะพั ัะฐะนะป ะฝะฐัััะฐะธะฒะฐะตั ProxyJump ะดะปั ะดะพัััะฟะฐ ะบ ะดััะณะธะผ ะฟะพะปัะทะพะฒะฐัะตะปัะผ

# ะะฐัััะพะนะบะธ ะฟะพ ัะผะพะปัะฐะฝะธั ะดะปั ะฒัะตั ัะพััะพะฒ
Host *
    # ะัะฟะพะปัะทะพะฒะฐัั SSH-ะฐะณะตะฝั ะดะปั ะฟะตัะตััะปะบะธ ะบะปััะตะน
    ForwardAgent yes
    # ะัะบะปััะธัั ัััะพะณัั ะฟัะพะฒะตัะบั ะบะปััะตะน ะดะปั localhost (ะดะปั ProxyJump)
    StrictHostKeyChecking no
    # ะัะบะปััะธัั ะดะพะฑะฐะฒะปะตะฝะธะต ะบะปััะตะน localhost ะฒ known_hosts
    UserKnownHostsFile /dev/null
    # ะะฝัะตัะฒะฐะป keepalive ะดะปั ะฟะพะดะดะตัะถะฐะฝะธั ัะพะตะดะธะฝะตะฝะธั
    ServerAliveInterval 60
    # ะะพะปะธัะตััะฒะพ keepalive-ะฟะฐะบะตัะพะฒ ะฟะตัะตะด ัะฐะทััะฒะพะผ ัะพะตะดะธะฝะตะฝะธั
    ServerAliveCountMax 3

# ะัะธะผะตั: ProxyJump ะดะปั ะดะพัััะฟะฐ ะบ ะฟะพะปัะทะพะฒะฐัะตะปั ัะตัะตะท localhost
# ะัะฟะพะปัะทะพะฒะฐะฝะธะต: ssh -J gate@server user@user-via-gate
Host user-via-gate
    HostName 127.0.0.1
    User <target_user>
    ProxyJump gate@127.0.0.1

# ะะพะฑะฐะฒััะต ััะดะฐ ะดะพะฟะพะปะฝะธัะตะปัะฝัะต Host-ะทะฐะฟะธัะธ ะดะปั ะบะฐะถะดะพะณะพ ะฟะพะปัะทะพะฒะฐัะตะปั
EOF

    # ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฟัะฐะฒะฐ ะฝะฐ ะบะพะฝัะธะณ
    chmod 600 /home/gate/.ssh/config
    chown gate:gate /home/gate/.ssh/config
    
    echo "  โ Gate-ะฟะพะปัะทะพะฒะฐัะตะปั ะฝะฐัััะพะตะฝ"
    echo ""
    echo "  ๐ ะะฐะถะฝะพ! ะะพะฑะฐะฒััะต ะฟัะฑะปะธัะฝัะต SSH-ะบะปััะธ ะฒ:"
    echo "     /home/gate/.ssh/authorized_keys"
    echo ""
    echo "  ๐ง ะะปั ะดะพัััะฟะฐ ะบ ะดััะณะธะผ ะฟะพะปัะทะพะฒะฐัะตะปัะผ ะธัะฟะพะปัะทัะนัะต:"
    echo "     ssh -J gate@server target_user@localhost"
}

################################################################################
# ะคัะฝะบัะธั: ะัะบะปััะตะฝะธะต root-ะดะพัััะฟะฐ
# ะะฟะธัะฐะฝะธะต: ะะปะพะบะธััะตั ะฟะฐัะพะปั root ะธ ะทะฐะฟัะตัะฐะตั SSH-ะฒัะพะด ะฟะพะด root
################################################################################
disable_root_access() {
    echo "๐ ะัะบะปััะตะฝะธะต root-ะดะพัััะฟะฐ..."
    
    # ะกะพะทะดะฐัะผ ัะตะทะตัะฒะฝัั ะบะพะฟะธั ะบะพะฝัะธะณััะฐัะธะธ SSH
    echo "  ๐พ ะกะพะทะดะฐะฝะธะต ัะตะทะตัะฒะฝะพะน ะบะพะฟะธะธ sshd_config..."
    cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup_$(date +%Y%m%d_%H%M%S)
    
    # ะะปะพะบะธััะตะผ ะฟะฐัะพะปั root (ัััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฝะตะฒะฐะปะธะดะฝัะน ัะตั)
    # passwd -l: lock - ะฑะปะพะบะธัะพะฒะบะฐ ััััะฝะพะน ะทะฐะฟะธัะธ
    echo "  ๐ ะะปะพะบะธัะพะฒะบะฐ ะฟะฐัะพะปั root..."
    passwd -l root
    
    # ะัะพะฒะตัะบะฐ ััะฟะตัะฝะพััะธ ะฑะปะพะบะธัะพะฒะบะธ
    if [ $? -eq 0 ]; then
        echo "  โ ะะฐัะพะปั root ะทะฐะฑะปะพะบะธัะพะฒะฐะฝ"
    else
        echo "  โ๏ธ  ะัะตะดัะฟัะตะถะดะตะฝะธะต: ะะต ัะดะฐะปะพัั ะทะฐะฑะปะพะบะธัะพะฒะฐัั ะฟะฐัะพะปั root"
    fi
    
    # ะะฐะฟัะตัะฐะตะผ SSH-ะฒัะพะด ะฟะพะด root ะฒ ะบะพะฝัะธะณััะฐัะธะธ sshd
    echo "  ๐ซ ะะฐะฟัะตั SSH-ะฒัะพะดะฐ ะดะปั root..."
    
    # ะัะพะฒะตััะตะผ, ะตััั ะปะธ ัะถะต ะดะธัะตะบัะธะฒะฐ PermitRootLogin
    if grep -q "^PermitRootLogin" /etc/ssh/sshd_config; then
        # ะัะปะธ ะตััั, ะทะฐะผะตะฝัะตะผ ะฝะฐ "no"
        sed -i 's/^PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config
    else
        # ะัะปะธ ะฝะตั, ะดะพะฑะฐะฒะปัะตะผ ะฒ ะบะพะฝะตั ัะฐะนะปะฐ
        echo "PermitRootLogin no" >> /etc/ssh/sshd_config
    fi
    
    # ะัะบะปััะฐะตะผ ะฐััะตะฝัะธัะธะบะฐัะธั ะฟะพ ะฟะฐัะพะปั (ัะพะปัะบะพ ะฟะพ ะบะปััะฐะผ)
    echo "  ๐ ะะฐัััะพะนะบะฐ ะฐััะตะฝัะธัะธะบะฐัะธะธ ัะพะปัะบะพ ะฟะพ SSH-ะบะปััะฐะผ..."
    
    # ะะฐะฟัะตัะฐะตะผ ะฐััะตะฝัะธัะธะบะฐัะธั ะฟะพ ะฟะฐัะพะปั
    if grep -q "^PasswordAuthentication" /etc/ssh/sshd_config; then
        sed -i 's/^PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config
    else
        echo "PasswordAuthentication no" >> /etc/ssh/sshd_config
    fi
    
    # ะะฐะทัะตัะฐะตะผ ะฐััะตะฝัะธัะธะบะฐัะธั ะฟะพ ะฟัะฑะปะธัะฝะพะผั ะบะปััั
    if grep -q "^PubkeyAuthentication" /etc/ssh/sshd_config; then
        sed -i 's/^PubkeyAuthentication.*/PubkeyAuthentication yes/' /etc/ssh/sshd_config
    else
        echo "PubkeyAuthentication yes" >> /etc/ssh/sshd_config
    fi
    
    # ะัะพะฒะตััะตะผ ะบะพะฝัะธะณััะฐัะธั SSH ะฟะตัะตะด ะฟะตัะตะทะฐะฟััะบะพะผ
    echo "  ๐ ะัะพะฒะตัะบะฐ ะบะพะฝัะธะณััะฐัะธะธ SSH..."
    # sshd -t: ัะตััะพะฒัะน ัะตะถะธะผ (ะฟัะพะฒะตัะบะฐ ัะธะฝัะฐะบัะธัะฐ)
    if sshd -t; then
        echo "  โ ะะพะฝัะธะณััะฐัะธั SSH ะบะพััะตะบัะฝะฐ"
        
        # ะะตัะตะทะฐะฟััะบะฐะตะผ ัะปัะถะฑั SSH ะดะปั ะฟัะธะผะตะฝะตะฝะธั ะธะทะผะตะฝะตะฝะธะน
        echo "  ๐ ะะตัะตะทะฐะฟััะบ SSH-ัะปัะถะฑั..."
        systemctl restart sshd
        
        if [ $? -eq 0 ]; then
            echo "  โ SSH-ัะปัะถะฑะฐ ะฟะตัะตะทะฐะฟััะตะฝะฐ ััะฟะตัะฝะพ"
        else
            echo "  โ ะัะธะฑะบะฐ ะฟะตัะตะทะฐะฟััะบะฐ SSH-ัะปัะถะฑั"
            echo "  ๐ ะะพัััะฐะฝะพะฒะปะตะฝะธะต ะธะท ัะตะทะตัะฒะฝะพะน ะบะพะฟะธะธ..."
            # ะ ัะปััะฐะต ะพัะธะฑะบะธ ะฒะพัััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะธะท backup
            cp /etc/ssh/sshd_config.backup_$(date +%Y%m%d_%H%M%S) /etc/ssh/sshd_config
            systemctl restart sshd
            return 1
        fi
    else
        echo "  โ ะัะธะฑะบะฐ ะฒ ะบะพะฝัะธะณััะฐัะธะธ SSH!"
        echo "  ๐ ะะพัััะฐะฝะพะฒะปะตะฝะธะต ะธะท ัะตะทะตัะฒะฝะพะน ะบะพะฟะธะธ..."
        cp /etc/ssh/sshd_config.backup_$(date +%Y%m%d_%H%M%S) /etc/ssh/sshd_config
        return 1
    fi
    
    echo "  โ Root-ะดะพัััะฟ ะพัะบะปััะตะฝ ััะฟะตัะฝะพ"
    echo ""
    echo "  โ๏ธ  ะะะะะะะะ!"
    echo "  - SSH-ะฒัะพะด ะฟะพะด root ัะตะฟะตัั ะทะฐะฟัะตััะฝ"
    echo "  - ะััะตะฝัะธัะธะบะฐัะธั ะฒะพะทะผะพะถะฝะฐ ัะพะปัะบะพ ะฟะพ SSH-ะบะปััะฐะผ"
    echo "  - ะะปั ะดะพัััะฟะฐ ะธัะฟะพะปัะทัะนัะต gate-ะฟะพะปัะทะพะฒะฐัะตะปั"
}

################################################################################
# ะคัะฝะบัะธั: ะะฐัััะพะนะบะฐ ProxyJump ะดะปั ะฟะพะปัะทะพะฒะฐัะตะปะตะน
# ะะฟะธัะฐะฝะธะต: ะกะพะทะดะฐัั helper-ัะบัะธะฟั ะดะปั ะฝะฐัััะพะนะบะธ ProxyJump ะดะพัััะฟะฐ
################################################################################
setup_proxyjump_helper() {
    echo "๐ง ะกะพะทะดะฐะฝะธะต helper-ัะบัะธะฟัะฐ ะดะปั ProxyJump..."
    
    # ะกะพะทะดะฐัะผ ัะบัะธะฟั-ะฟะพะผะพัะฝะธะบ ะฒ /usr/local/bin
    cat > /usr/local/bin/add-proxyjump-user << 'EOFSCRIPT'
#!/bin/bash
################################################################################
# Helper-ัะบัะธะฟั ะดะปั ะดะพะฑะฐะฒะปะตะฝะธั ะฟะพะปัะทะพะฒะฐัะตะปั ั ProxyJump ะดะพัััะฟะพะผ
# ะัะฟะพะปัะทะพะฒะฐะฝะธะต: add-proxyjump-user <username>
################################################################################

# ะัะพะฒะตัะบะฐ ะฝะฐะปะธัะธั ะฐัะณัะผะตะฝัะฐ (ะธะผั ะฟะพะปัะทะพะฒะฐัะตะปั)
if [ -z "$1" ]; then
    echo "ะัะฟะพะปัะทะพะฒะฐะฝะธะต: $0 <username>"
    echo "ะัะธะผะตั: $0 developer"
    exit 1
fi

USERNAME=$1

# ะัะพะฒะตัะบะฐ ะฟัะฐะฒ root
if [ "$EUID" -ne 0 ]; then 
    echo "โ ะขัะตะฑััััั ะฟัะฐะฒะฐ root"
    exit 1
fi

echo "๐ค ะกะพะทะดะฐะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปั $USERNAME..."

# ะกะพะทะดะฐัะผ ะฟะพะปัะทะพะฒะฐัะตะปั
useradd -m -s /bin/bash -c "User via Gate" "$USERNAME"

if [ $? -ne 0 ]; then
    echo "โ ะัะธะฑะบะฐ ัะพะทะดะฐะฝะธั ะฟะพะปัะทะพะฒะฐัะตะปั"
    exit 1
fi

# ะะฐัััะฐะธะฒะฐะตะผ SSH ะดะปั ะฝะพะฒะพะณะพ ะฟะพะปัะทะพะฒะฐัะตะปั
mkdir -p /home/$USERNAME/.ssh
touch /home/$USERNAME/.ssh/authorized_keys
chmod 700 /home/$USERNAME/.ssh
chmod 600 /home/$USERNAME/.ssh/authorized_keys
chown -R $USERNAME:$USERNAME /home/$USERNAME/.ssh

# ะะพะฑะฐะฒะปัะตะผ ะบะพะฝัะธะณััะฐัะธั ะฒ gate
echo "" >> /home/gate/.ssh/config
echo "# ProxyJump ะดะปั $USERNAME" >> /home/gate/.ssh/config
echo "Host $USERNAME-via-gate" >> /home/gate/.ssh/config
echo "    HostName 127.0.0.1" >> /home/gate/.ssh/config
echo "    User $USERNAME" >> /home/gate/.ssh/config
echo "    ProxyJump gate@127.0.0.1" >> /home/gate/.ssh/config

echo "โ ะะพะปัะทะพะฒะฐัะตะปั $USERNAME ัะพะทะดะฐะฝ"
echo ""
echo "๐ ะกะปะตะดัััะธะต ัะฐะณะธ:"
echo "1. ะะพะฑะฐะฒััะต ะฟัะฑะปะธัะฝัะน SSH-ะบะปัั ะฒ:"
echo "   /home/$USERNAME/.ssh/authorized_keys"
echo ""
echo "2. ะะปั ะฟะพะดะบะปััะตะฝะธั ะธัะฟะพะปัะทัะนัะต:"
echo "   ssh -J gate@server $USERNAME@localhost"
echo "   ะธะปะธ"
echo "   ssh $USERNAME-via-gate"

EOFSCRIPT

    # ะะตะปะฐะตะผ ัะบัะธะฟั ะธัะฟะพะปะฝัะตะผัะผ
    chmod +x /usr/local/bin/add-proxyjump-user
    
    echo "  โ Helper-ัะบัะธะฟั ัะพะทะดะฐะฝ: /usr/local/bin/add-proxyjump-user"
    echo "  ๐ ะัะฟะพะปัะทะพะฒะฐะฝะธะต: add-proxyjump-user <username>"
}

################################################################################
# ะคัะฝะบัะธั: ะัะฒะพะด ะธัะพะณะพะฒะพะน ะธะฝัะพัะผะฐัะธะธ
################################################################################
print_summary() {
    echo ""
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo "โ ะะะกะขะะะะะ SSH-ะะะะะะะกะะะกะขะ ะะะะะะจะะะ"
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo ""
    echo "๐ ะัะฟะพะปะฝะตะฝะฝัะต ะดะตะนััะฒะธั:"
    echo "  โ MOTD ะฝะฐัััะพะตะฝ (ะบะฐััะพะผะฝัะน ะฑะฐะฝะฝะตั)"
    echo "  โ Gate-ะฟะพะปัะทะพะฒะฐัะตะปั ัะพะทะดะฐะฝ"
    echo "  โ Root-ะดะพัััะฟ ะพัะบะปััะตะฝ"
    echo "  โ SSH ะฝะฐัััะพะตะฝ ะฝะฐ ะฐััะตะฝัะธัะธะบะฐัะธั ะฟะพ ะบะปััะฐะผ"
    echo ""
    echo "๐ ะกะปะตะดัััะธะต ัะฐะณะธ:"
    echo ""
    echo "1๏ธโฃ  ะะพะฑะฐะฒััะต ัะฒะพะน ะฟัะฑะปะธัะฝัะน SSH-ะบะปัั ะดะปั gate:"
    echo "   echo 'your-public-key' >> /home/gate/.ssh/authorized_keys"
    echo ""
    echo "2๏ธโฃ  ะกะพะทะดะฐะนัะต ะดะพะฟะพะปะฝะธัะตะปัะฝัั ะฟะพะปัะทะพะฒะฐัะตะปะตะน ัะตัะตะท gate:"
    echo "   add-proxyjump-user username"
    echo ""
    echo "3๏ธโฃ  ะะพะดะบะปััะฐะนัะตัั ัะตัะตะท gate ั ProxyJump:"
    echo "   ssh -J gate@your-server username@localhost"
    echo ""
    echo "โ๏ธ  ะะะะะ: ะะตัะตะด ะฒััะพะดะพะผ ัะฑะตะดะธัะตัั, ััะพ ะผะพะถะตัะต"
    echo "   ะฟะพะดะบะปััะธัััั ัะตัะตะท gate, ะธะฝะฐัะต ะฟะพัะตััะตัะต ะดะพัััะฟ!"
    echo ""
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
}

################################################################################
# ะัะฝะพะฒะฝะพะน ะฑะปะพะบ ะฒัะฟะพะปะฝะตะฝะธั
################################################################################

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ      ๐ ะะะกะขะะะะะ SSH-ะะะะะะะกะะะกะขะ ะ MOTD                      โ"
echo "โ      Sandrick Tech - Server Security Setup                      โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# ะัะฟะพะปะฝัะตะผ ะฒัะต ััะฝะบัะธะธ ะฟะพัะปะตะดะพะฒะฐัะตะปัะฝะพ
setup_motd
echo ""
create_gate_user
echo ""
setup_proxyjump_helper
echo ""
disable_root_access
echo ""
print_summary

# ะะฐะฒะตััะตะฝะธะต ัะฐะฑะพัั ัะบัะธะฟัะฐ
exit 0
