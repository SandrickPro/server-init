–¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –ó–ê–î–ê–ù–ò–ï (–¢–ó)
–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞–º–∏, –ø–æ—Ä—Ç–∞–º–∏, iptables –∏ SSH-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è–º–∏
–ü—Ä–æ–µ–∫—Ç: /srv/sys ‚Äî —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–æ–º
1. –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã

–°–æ–∑–¥–∞—Ç—å –µ–¥–∏–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å–µ—Ä–≤–µ—Ä–∞, –≤–∫–ª—é—á–∞—é—â–∏–π:

—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –ø–æ—Ä—Ç–æ–≤ –∏ —Å–ª—É–∂–±,

–≥–µ–Ω–µ—Ä–∞—Ü–∏—é iptables-–ø–æ–ª–∏—Ç–∏–∫,

—Å–æ–∑–¥–∞–Ω–∏–µ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫—É —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö systemd-—Å–µ—Ä–≤–∏—Å–æ–≤,

—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ SSH-–ø—Ä–æ–∫—Å–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è Windows/macOS/Linux –∫–ª–∏–µ–Ω—Ç–æ–≤,

—Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–æ–≤,

–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º SID.

–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –æ–¥–Ω–∏–º bash-—Å–∫—Ä–∏–ø—Ç–æ–º (setup_sys.sh), –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç –∫–∞—Ç–∞–ª–æ–≥–∏, –ø—Ä–∞–≤–∏–ª–∞, —Å–µ—Ä–≤–∏—Å—ã –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.

2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π

–í—Å–µ —Ñ–∞–π–ª—ã –¥–æ–ª–∂–Ω—ã —Ä–∞—Å–ø–æ–ª–∞–≥–∞—Ç—å—Å—è –≤ –∫–∞—Ç–∞–ª–æ–≥–µ:/srv/sys/
2.1. –ü–æ–¥–∫–∞—Ç–∞–ª–æ–≥–∏
2.1.1 systemd
/srv/sys/systemd/system/
    ‚îú‚îÄ‚îÄ ssh-session@.service
    ‚îî‚îÄ‚îÄ iptables-restore.service

2.1.2 iptables
/srv/sys/iptables/v4/
    ‚îú‚îÄ‚îÄ ssh.v4
    ‚îú‚îÄ‚îÄ ssh.v4.inactive
    ‚îú‚îÄ‚îÄ smtp.v4
    ‚îú‚îÄ‚îÄ smtp.v4.inactive
    ‚îú‚îÄ‚îÄ ...
    ‚îî‚îÄ‚îÄ combined.v4

/srv/sys/iptables/v6/
    ‚îú‚îÄ‚îÄ ssh.v6
    ‚îú‚îÄ‚îÄ ssh.v6.inactive
    ‚îú‚îÄ‚îÄ smtp.v6
    ‚îú‚îÄ‚îÄ smtp.v6.inactive
    ‚îî‚îÄ‚îÄ combined.v6

2.1.3 ssh
/srv/sys/ssh/win_config/config
–≠—Ç–æ—Ç —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –µ–¥–∏–Ω—ã–π ProxyJump-–∫–æ–Ω—Ñ–∏–≥ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ —É–∑–µ–ª gate.

3. –°–µ—Ä–≤–∏—Å—ã, —É–ø—Ä–∞–≤–ª—è–µ–º—ã–µ —Å–∏—Å—Ç–µ–º–æ–π

–¢–∏–ø–æ–≤—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:

–°–µ—Ä–≤–∏—Å	–ü–æ—Ä—Ç	–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
ssh	22	SSH –¥–æ—Å—Ç—É–ø
smtp	25	–ü–æ—á—Ç–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä
imaps	993	Mail over TLS
mysql	3306	–ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
http	80	Web
https	443	Web TLS

–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å.

4. –ü–æ–≤–µ–¥–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞

–û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç:

—Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç —É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:
‚Äú–û—Ç–∫—Ä—ã—Ç—å –ø–æ—Ä—Ç –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ <SERVICE>? [y/N]‚Äù

–µ—Å–ª–∏ –î–∞ ‚Üí —Å–æ–∑–¥–∞—é—Ç—Å—è —Ñ–∞–π–ª—ã:
/srv/sys/iptables/v4/<service>.v4
/srv/sys/iptables/v6/<service>.v6

–µ—Å–ª–∏ –ù–µ—Ç ‚Üí —Å–æ–∑–¥–∞—é—Ç—Å—è:
/srv/sys/iptables/v4/<service>.v4.inactive
/srv/sys/iptables/v6/<service>.v6.inactive

–ø–æ—Å–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ ‚Äî –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è:

/srv/sys/iptables/v4/combined.v4

/srv/sys/iptables/v6/combined.v6

—Å–æ–∑–¥–∞—ë—Ç—Å—è systemd unit –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª iptables:
/srv/sys/systemd/system/iptables-restore.service

5. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SSH ProxyJump –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

–°–∫—Ä–∏–ø—Ç:

–ø—Ä–∏–Ω–∏–º–∞–µ—Ç USERNAME, SERVER_IP, SSH_PORT,

–¥–æ–±–∞–≤–ª—è–µ—Ç –≤ /srv/sys/ssh/win_config/config –±–ª–æ–∫:
Host <USERNAME>
    HostName <SERVER_IP>
    Port <SSH_PORT>
    User <USERNAME>
    ProxyJump gate@<SERVER_IP>
    IdentityFile ~/.ssh/<USERNAME>.key

–§–∞–π–ª —è–≤–ª—è–µ—Ç—Å—è –µ–¥–∏–Ω—ã–º –∫–æ–Ω—Ñ–∏–≥–æ–º –¥–ª—è –≤—Å–µ—Ö —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏—Ö –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ gate.

6. –°–∏—Å—Ç–µ–º–∞ SID

–ö–∞–∂–¥–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞—ë—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä:
SID = <IP>_<USER>_<DATE>_<STARTTIME>

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∞—É–¥–∏—Ç–∞ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è.

7. Systemd —Å–µ—Ä–≤–∏—Å—ã
7.1. ssh-session@.service

–®–∞–±–ª–æ–Ω–Ω—ã–π unit:
ssh-session@<username>.service

–û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–æ–±—ã—Ç–∏–π –Ω–∞—á–∞–ª–∞ –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è SSH-—Å–µ—Å—Å–∏–π.

7.2. iptables-restore.service

–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∏—Ç–æ–≥–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞ iptables –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–µ—Ä–≤–µ—Ä–∞.
ExecStart=/usr/sbin/iptables-restore < /srv/sys/iptables/v4/combined.v4

8. –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ä–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç–∏

–°–∏—Å—Ç–µ–º–∞ –¥–æ–ª–∂–Ω–∞:

–ø–æ–∑–≤–æ–ª—è—Ç—å –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π,

—Ä–∞—Å—à–∏—Ä—è—Ç—å —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–∏—Å–æ–≤,

–ø–æ–¥–∫–ª—é—á–∞—Ç—å –ª—é–±—É—é –ª–æ–≥–∏–∫—É –¥–ª—è –±—É–¥—É—â–µ–≥–æ Firewall/SSH/Logging,

—Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–Ω–µ—à–Ω–µ–≥–æ —Å–æ—Ñ—Ç–∞.

üî• –ü–†–ï–î–õ–û–ñ–ï–ù–ò–Ø –ü–û –î–ê–õ–¨–ù–ï–ô–®–ï–ú–£ –†–ê–°–®–ò–†–ï–ù–ò–Æ –§–£–ù–ö–¶–ò–û–ù–ê–õ–ê

–ù–∏–∂–µ ‚Äî –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π roadmap —É–ª—É—á—à–µ–Ω–∏–π.

‚ûï 1. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ fail2ban –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ jail'–∞–º–∏

–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è jail-—Ñ–∞–π–ª–æ–≤ –≤ /srv/sys/fail2ban/,

–≤—ã–±–æ—Ä: –≤–∫–ª—é—á–∏—Ç—å / –æ—Ç–∫–ª—é—á–∏—Ç—å jail,

–µ–¥–∏–Ω—ã–π combined.conf.

‚ûï 2. –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π Firewall Controller

–§—É–Ω–∫—Ü–∏–∏:

–≥—Ä—É–ø–ø—ã –ø–æ—Ä—Ç–æ–≤ (web, mail, db, admin),

–ø—Ä–æ—Ñ–∏–ª–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏,

ACL –ø–æ IP,

–∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π.

‚ûï 3. –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ SSH-–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–æ–±–∞–≤–∏—Ç—å:

–∂—É—Ä–Ω–∞–ª –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π,

–æ—Ç–¥–µ–ª—å–Ω—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –ª–æ–≥–æ–≤ –∫–∞–∂–¥–æ–≥–æ SID,

—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –≤—Ö–æ–¥–µ –≤ Telegram.

‚ûï 4. –ê–≤—Ç–æ—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è:

—Å–æ–∑–¥–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è,

–≥–µ–Ω–µ—Ä–∞—Ü–∏—è SSH –∫–ª—é—á–µ–π,

–≤—ã–¥–∞—á–∞ .key –≤ win_config,

–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ sudo/–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π.

‚ûï 5. –°–∏—Å—Ç–µ–º–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥–æ–≤

–ï–¥–∏–Ω—ã–π Backup Controller:

–∞—Ä—Ö–∏–≤–∞—Ü–∏—è /srv/sys,

—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ S3/WebDAV/rsync,

—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —á–µ—Ä–µ–∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π systemd.timer.

‚ûï 6. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ SandrickTechPanel

–î–æ–±–∞–≤–∏—Ç—å API:

GET/POST /api/sys/iptables

GET/POST /api/sys/ssh-config

GET /api/sys/sessions

–ò UI:

–ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ —Å–µ—Ä–≤–∏—Å–æ–≤ (–ø–æ—Ä—Ç–æ–≤),

—Ä–µ–¥–∞–∫—Ç–æ—Ä –ø—Ä–∞–≤–∏–ª,

–ø—Ä–æ—Å–º–æ—Ç—Ä –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω–æ–≥–æ firewall,

–ø—Ä–æ—Å–º–æ—Ç—Ä –∞–∫—Ç–∏–≤–Ω—ã—Ö SSH-—Å–µ—Å—Å–∏–π.

‚ûï 7. –¢–µ–ª–µ–º–µ—Ç—Ä–∏—è –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–î–æ–±–∞–≤–∏—Ç—å:

—Å–∫–æ—Ä–æ—Å—Ç—å –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π,

–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ SSH –ø–æ–ø—ã—Ç–æ–∫,

—Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—Å–µ—Ö –ø–æ—Ä—Ç–æ–≤,

–æ—Ç—Å—ã–ª–∫—É –≤ InfluxDB/Prometheus.

‚ûï 8. –ö–æ–Ω—Ç—Ä–æ–ª—å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏

–ü–æ–¥–¥–µ—Ä–∂–∫–∞:

sha256 –¥–ª—è –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –≤ /srv/sys,

–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤,

–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –≤ Telegram –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö.

‚ûï 9. –ú–µ—Ö–∞–Ω–∏–∑–º Rollback

–î–ª—è –≤—Å–µ—Ö –ø—Ä–∞–≤–∏–ª:

—Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤–µ—Ä—Å–∏—é,

–ø–æ–∑–≤–æ–ª—è—Ç—å –æ—Ç–∫–∞—Ç–∏—Ç—å—Å—è –Ω–∞ –ª—é–±—É—é –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –≤–µ—Ä—Å–∏–π.

‚ûï 10. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Docker/Podman —Å–µ—Ä–≤–∏—Å–æ–≤

–û—Ç–∫—Ä—ã–≤–∞—Ç—å –ø–æ—Ä—Ç—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ —á–µ—Ä–µ–∑ —ç—Ç—É –∂–µ —Å–∏—Å—Ç–µ–º—É:

docker run --label firewall=http

–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª.
I. –ü–û–î–†–û–ë–ù–û–ï –û–ü–ò–°–ê–ù–ò–ï –¢–û–ì–û, –ß–¢–û –£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û –í –°–ö–†–ò–ü–¢–ï
1. –°—Ç—Ä–æ–≥–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç:

set -euo pipefail ‚Äî –∞–≤–∞—Ä–∏–π–Ω—ã–π –≤—ã—Ö–æ–¥ –ø—Ä–∏ –ª—é–±—ã—Ö –æ—à–∏–±–∫–∞—Ö.

–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—É—é —É—Å—Ç–∞–Ω–æ–≤–∫—É IFS –≤ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä–µ–∂–∏–º.

–ø—Ä–æ–≤–µ—Ä–∫—É, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω —Å—Ç—Ä–æ–≥–æ –æ—Ç root.

–≠—Ç–æ –∏—Å–∫–ª—é—á–∞–µ—Ç 90% –æ—à–∏–±–æ–∫ –ø—Ä–∏ —Å–∏—Å—Ç–µ–º–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–µ.

2. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø—É—Ç–µ–π –∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

–°–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞—ë—Ç —Å–∏—Å—Ç–µ–º–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É:
/srv/sys
/srv/sys/ssh
/srv/sys/ssh/sshd_config.d
/srv/sys/ssh/def_ssh_conf
/srv/sys/ssh/key-export
/srv/sys/ssh/win_config
/srv/sys/ssh/ssh_session
/srv/sys/ssh/ssh_fail2ban/hits
/srv/sys/ssh/ssh_fail2ban/level
/srv/sys/tmp
/srv/sys/audit/rules.d
/srv/sys/systemd/system
/srv/sys/sudoers.d
/srv/sys/etc/profile.d
/srv/sys/iptables/v4
/srv/sys/iptables/v6
/srv/home

–í—Å–µ –∫–∞—Ç–∞–ª–æ–≥–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏.

3. –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö auth-—Ñ–∞–π–ª–æ–≤

–°–æ–∑–¥–∞—ë—Ç:
/srv/sys/backup_passwd/passwd.YYYYMMDD_HHMMSS
–§–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–ø–∏—é:

/etc/passwd

/etc/shadow

/etc/group

/etc/gshadow

–≠—Ç–æ ‚Äî —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –Ω–∞ —Å–ª—É—á–∞–π –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.

4. –°–æ–∑–¥–∞–Ω–∏–µ ¬´–±–æ–ª–≤–∞–Ω–∞¬ª sshd_config

–°–∫—Ä–∏–ø—Ç:

–Ω–∞—Ö–æ–¥–∏—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π /usr/share/openssh/sshd_config –∏–ª–∏ /etc/ssh/sshd_config,

–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–µ—Ç –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É,

—Å–æ–∑–¥–∞—ë—Ç —Ñ–∞–π–ª:
/srv/sys/ssh/def_ssh_conf/default_sshd_config_from_share
–≤ –∫–æ–Ω–µ—Ü –¥–æ–±–∞–≤–ª—è–µ—Ç:
Include /srv/sys/ssh/sshd_config.d/*.conf

–†–µ–∑—É–ª—å—Ç–∞—Ç ‚Äî –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è –æ—Å–Ω–æ–≤–∞ –¥–ª—è –º–æ–¥—É–ª—å–Ω–æ–≥–æ SSH-–∫–æ–Ω—Ñ–∏–≥–∞.

5. –§—É–Ω–∫—Ü–∏–∏ –∏ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö SID –∏–º—ë–Ω

–°–∫—Ä–∏–ø—Ç —Ä–µ–∞–ª–∏–∑—É–µ—Ç:

date_label() ‚Äî —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã

time_HM() ‚Äî –≤—Ä–µ–º—è

sid_build(ip, user, start)

session_filename(sid, user, start, end)

tmp_filename(user, start, sid)

format_banlog_date()

–≠—Ç–æ ‚Äî –±–∞–∑–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∞—É–¥–∏—Ç–∞ SSH, —Ñ–∏–∫—Å–∞—Ü–∏–∏ —Å–µ—Å—Å–∏–π –∏ –ª–æ–≥–∞ –±–∞–Ω–æ–≤.

6. –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã Fail2Ban-–ø–æ–¥–æ–±–Ω–æ–≥–æ –º–µ—Ö–∞–Ω–∏–∑–º–∞

–ö–∞—Ç–∞–ª–æ–≥–∏:
/srv/sys/ssh/ssh_fail2ban/hits
/srv/sys/ssh/ssh_fail2ban/level
/srv/sys/ssh/ssh_fail2ban/bans.log
/srv/sys/ssh/ssh_fail2ban/white_events.log

–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ø–∏—Å–∫–æ–≤:

IP, —Ç—Ä–µ–±—É—é—â–∏—Ö –±–∞–Ω

–±–µ–ª—ã–µ —Å–ø–∏—Å–∫–∏

—É—Ä–æ–≤–Ω–∏ —à—Ç—Ä–∞—Ñ–æ–≤

–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

–≠—Ç–æ –±–∞–∑–∞ –ø–æ–¥ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–æ–≥ Fail2Ban.

7. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è iptables

–°–∫—Ä–∏–ø—Ç –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –Ω–∞–ª–∏—á–∏–µ:
/srv/sys/iptables/v4
/srv/sys/iptables/v6
–ò –ø–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª:

–∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞: *.v4, *.v6

–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ: *.v4.inactive, *.v6.inactive

–±—É–¥—É—â–∏–µ combined –ø—Ä–∞–≤–∏–ª–∞.

8. –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è systemd-—Å–µ—Ä–≤–∏—Å–æ–≤

–ö–∞—Ç–∞–ª–æ–≥:
/srv/sys/systemd/system

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —à–∞–±–ª–æ–Ω–æ–≤, –ø—Ä–µ–∂–¥–µ —á–µ–º –æ–Ω–∏ –±—É–¥—É—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤:/etc/systemd/system
–°–∫—Ä–∏–ø—Ç —É—á–∏—Ç—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–æ:

systemd-—Ñ–∞–π–ª—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ /srv/sys/

–∞ –ø–æ—Ç–æ–º –≤—Ä—É—á–Ω—É—é –∫–æ–ø–∏—Ä—É—é—Ç—Å—è –≤ /etc/systemd/system

–≠—Ç–æ —á–∞—Å—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã.

9. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤configs / sudoers / profile.d

–ö–∞—Ç–∞–ª–æ–≥–∏:/srv/sys/sudoers.d
/srv/sys/etc/profile.d
–°–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞—ë—Ç –∏—Ö –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏.

10. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è Windows SSH ProxyJump –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

–§–∞–π–ª:/srv/sys/ssh/win_config/config

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –µ–¥–∏–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª WinSCP/OpenSSH —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π:
ProxyJump gate@<SERVER_IP>
IdentityFile ~/.ssh/<USERNAME>.key

–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
2.1. –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π

–°–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω:

—Å–æ–∑–¥–∞—Ç—å –ø–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π, –≤–∫–ª—é—á–∞—è systemd, iptables, ssh, –∞—É–¥–∏—Ç–∞, sudoers, profiles, –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤, —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π –∏ –¥–æ–º–∞—à–Ω–µ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞.

—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –ø—Ä–∞–≤–∞.

2.2. –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ auth-—Ñ–∞–π–ª–æ–≤

–°–∫—Ä–∏–ø—Ç –æ–±—è–∑–∞–Ω:

—Å–æ–∑–¥–∞–≤–∞—Ç—å —Ç–æ—á–Ω—É—é –∫–æ–ø–∏—é —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏,

–ø–æ–º–µ—â–∞—Ç—å –∏—Ö –≤ /srv/sys/backup_passwd.

2.3. –°–æ–∑–¥–∞—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π ¬´–±–æ–ª–≤–∞–Ω¬ª –∫–æ–Ω—Ñ–∏–≥–∞ sshd

–°–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω:

–Ω–∞–π—Ç–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π sshd_config,

–∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ —Å—Ç—Ä–æ–∫–∏,

—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–ø–∏—é –≤ /srv/sys/ssh/def_ssh_conf/,

–¥–æ–±–∞–≤–∏—Ç—å –¥–∏—Ä–µ–∫—Ç–∏–≤—É Include –¥–ª—è –º–æ–¥—É–ª—å–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.

2.4. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è SID –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–º—ë–Ω —Ñ–∞–π–ª–æ–≤

–°–∫—Ä–∏–ø—Ç –æ–±—è–∑–∞–Ω –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å:

–≥–µ–Ω–µ—Ä–∞—Ü–∏—é SID –ø–æ —à–∞–±–ª–æ–Ω—É:
<IP>_<USER>_<DATE>_<STARTTIME>

—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç,

—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –¥–ª—è SSH-—Å–µ—Å—Å–∏–π,

—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º—ë–Ω –ª–æ–≥-—Ñ–∞–π–ª–æ–≤ —Å–µ—Å—Å–∏–π.

2.5. –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É Fail2Ban-–ø–æ–¥–æ–±–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã

–°–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–∑–¥–∞—Ç—å –∫–∞—Ç–∞–ª–æ–≥–∏:

–¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —É—Ä–æ–≤–Ω–µ–π –±–∞–Ω–æ–≤,

–¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ IP-—Ö–∏—Ç–æ–≤,

–¥–ª—è –ª–æ–≥–∞ –±–∞–Ω–æ–≤,

–¥–ª—è –±–µ–ª—ã—Ö —Å–æ–±—ã—Ç–∏–π.

2.6. –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è iptables

–°–∫—Ä–∏–ø—Ç –æ–±—è–∑–∞–Ω —Å–æ–∑–¥–∞—Ç—å –∫–∞—Ç–∞–ª–æ–≥–∏:
/srv/sys/iptables/v4
/srv/sys/iptables/v6
–∏ –æ–±–µ—Å–ø–µ—á–∏—Ç—å –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Ä–∞–∑–º–µ—â–µ–Ω–∏—é –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª.

2.7. –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è systemd

–°–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω:

–ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∫–∞—Ç–∞–ª–æ–≥ /srv/sys/systemd/system –¥–ª—è –±—É–¥—É—â–∏—Ö —é–Ω–∏—Ç–æ–≤.

2.8. –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∫–∞—Ç–∞–ª–æ–≥ SSH-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è Windows-–∫–ª–∏–µ–Ω—Ç–æ–≤

–°–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω:

—Å–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª /srv/sys/ssh/win_config/config,

–æ–±–µ—Å–ø–µ—á–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –≤ –∫–æ—Ç–æ—Ä—É—é –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è ProxyJump-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.

3. –ù–µ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
3.1. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ –æ—Ç root.

–ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö.

—Å—Ç—Ä–æ–≥–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö.

3.2. –ò–¥—ë–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

–ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø–æ—Ä—Ç–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É,

–ø–æ–≤—Ç–æ—Ä–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ.

3.3. –ü–µ—Ä–µ–Ω–æ—Å–∏–º–æ—Å—Ç—å

—Å–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ Debian/Ubuntu.
#!/bin/bash
set -e

BASE="/srv/sys"
DIR_SYSTEMD="$BASE/systemd/system"
DIR_IPT_V4="$BASE/iptables/v4"
DIR_IPT_V6="$BASE/iptables/v6"
DIR_SSH="$BASE/ssh"
WIN_CONFIG="$DIR_SSH/win_config/config"

SERVICES=("ssh" "smtp" "imaps" "mysql" "http" "https")

mkdir -p "$DIR_SYSTEMD" "$DIR_IPT_V4" "$DIR_IPT_V6" "$DIR_SSH/win_config"

# -------------------------------------------------------------------
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SID
# -------------------------------------------------------------------
generate_sid() {
    local ip="$1"
    local user="$2"
    local date=$(date +"%Y%m%d")
    local time=$(date +"%H%M")
    echo "${ip}_${user}_${date}_${time}"
}

# -------------------------------------------------------------------
# –°–æ–∑–¥–∞–Ω–∏–µ SSH ProxyJump –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
# -------------------------------------------------------------------
update_win_config() {
    local username="$1"
    local server_ip="$2"
    local ssh_port="$3"

    cat >> "$WIN_CONFIG" <<EOF

Host ${username}
    HostName ${server_ip}
    Port ${ssh_port}
    User ${username}
    ProxyJump gate@${server_ip}
    IdentityFile ~/.ssh/${username}.key
EOF
}

# -------------------------------------------------------------------
# –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ iptables –ø—Ä–∞–≤–∏–ª
# -------------------------------------------------------------------
create_iptables_rules() {
    local svc="$1"
    local open="$2"

    if [[ "$open" == "y" || "$open" == "Y" ]]; then
        v4="${DIR_IPT_V4}/${svc}.v4"
        v6="${DIR_IPT_V6}/${svc}.v6"
        suffix=""
    else
        v4="${DIR_IPT_V4}/${svc}.v4.inactive"
        v6="${DIR_IPT_V6}/${svc}.v6.inactive"
        suffix=".inactive"
    fi

    echo "*filter" > "$v4"
    echo ":INPUT ACCEPT [0:0]" >> "$v4"
    echo "-A INPUT -p tcp --dport ${PORT} -j ACCEPT" >> "$v4"
    echo "COMMIT" >> "$v4"

    echo "*filter" > "$v6"
    echo ":INPUT ACCEPT [0:0]" >> "$v6"
    echo "-A INPUT -p tcp --dport ${PORT} -j ACCEPT" >> "$v6"
    echo "COMMIT" >> "$v6"

    echo "[OK] iptables rules created: ${svc}${suffix}"
}

# -------------------------------------------------------------------
# –®–∞–±–ª–æ–Ω systemd —Å–µ—Ä–≤–∏—Å–∞ SSH session
# -------------------------------------------------------------------
create_ssh_session_service() {
cat > "$DIR_SYSTEMD/ssh-session@.service" <<EOF
[Unit]
Description=SSH session for %i
After=network.target

[Service]
Type=oneshot
ExecStart=/usr/bin/echo "Session started for %i"
ExecStop=/usr/bin/echo "Session finished for %i"
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF

echo "[OK] systemd template ssh-session@.service created"
}

# -------------------------------------------------------------------
# iptables-restore —Å–µ—Ä–≤–∏—Å
# -------------------------------------------------------------------
create_iptables_restore_service() {
cat > "$DIR_SYSTEMD/iptables-restore.service" <<EOF
[Unit]
Description=Restore iptables rules
DefaultDependencies=no
Before=network-pre.target
Wants=network-pre.target

[Service]
Type=oneshot
ExecStart=/usr/sbin/iptables-restore < $DIR_IPT_V4/combined.v4
ExecStart=/usr/sbin/ip6tables-restore < $DIR_IPT_V6/combined.v6

[Install]
WantedBy=multi-user.target
EOF

echo "[OK] iptables-restore.service created"
}

# -------------------------------------------------------------------
# –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª
# -------------------------------------------------------------------
combine_rules() {
    cat $DIR_IPT_V4/*.v4 > $DIR_IPT_V4/combined.v4
    cat $DIR_IPT_V6/*.v6 > $DIR_IPT_V6/combined.v6
}

# -------------------------------------------------------------------
# –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
# -------------------------------------------------------------------

create_ssh_session_service
create_iptables_restore_service

echo "=== –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ ==="

for svc in "${SERVICES[@]}"; do
    echo
    echo "–û—Ç–∫—Ä—ã—Ç—å –ø–æ—Ä—Ç –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ $svc ? [y/N]"
    read -r allow

    # –ü–æ—Ä—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    case "$svc" in
        ssh)   PORT=22 ;;
        smtp)  PORT=25 ;;
        imaps) PORT=993 ;;
        mysql) PORT=3306 ;;
        http)  PORT=80 ;;
        https) PORT=443 ;;
    esac

    create_iptables_rules "$svc" "$allow"
done

combine_rules

echo
echo "=== –°–æ–∑–¥–∞–Ω–∏–µ SSH ProxyJump –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ ==="
read -rp "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: " USERNAME
read -rp "–í–≤–µ–¥–∏—Ç–µ IP —Å–µ—Ä–≤–µ—Ä–∞: " SERVER_IP
read -rp "–í–≤–µ–¥–∏—Ç–µ SSH –ø–æ—Ä—Ç: " SSH_PORT

update_win_config "$USERNAME" "$SERVER_IP" "$SSH_PORT"

echo "[OK] win_config –æ–±–Ω–æ–≤–ª—ë–Ω"

SID=$(generate_sid "$SERVER_IP" "$USERNAME")
echo "SID=$SID"

echo
echo "=== –ì–û–¢–û–í–û ==="
echo "–í—Å–µ —Ñ–∞–π–ª—ã —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω—ã –≤ /srv/sys/"
