################################################################################
# SRV-SYS MASTER CONFIGURATION v1.0
# Автор: Sandrick Tech
# Дата: 2024-12-09
# Описание: Централизованный конфигурационный файл для всей системы /srv/sys/
#
# Этот файл используется ВСЕМИ компонентами системы как единый источник истины
# для путей, портов, IP адресов и других глобальных настроек
################################################################################

################################################################################
# БАЗОВАЯ КОНФИГУРАЦИЯ
################################################################################

# Версия конфигурации
SRV_SYS_VERSION="1.0"

# Базовая директория системы
SRV_SYS_BASE="/srv/sys"

# Режим работы: production | staging | development
SRV_SYS_MODE="production"

# Уровень логирования: debug | info | warn | error
SRV_SYS_LOG_LEVEL="info"

################################################################################
# СТРУКТУРА ДИРЕКТОРИЙ
################################################################################

# Конфигурации
SRV_SYS_CONFIGS="${SRV_SYS_BASE}/configs"
SRV_SYS_CONFIGS_NGINX="${SRV_SYS_CONFIGS}/nginx"
SRV_SYS_CONFIGS_MYSQL="${SRV_SYS_CONFIGS}/mysql"
SRV_SYS_CONFIGS_POSTGRESQL="${SRV_SYS_CONFIGS}/postgresql"
SRV_SYS_CONFIGS_REDIS="${SRV_SYS_CONFIGS}/redis"
SRV_SYS_CONFIGS_MONGODB="${SRV_SYS_CONFIGS}/mongodb"
SRV_SYS_CONFIGS_FAIL2BAN="${SRV_SYS_CONFIGS}/fail2ban"
SRV_SYS_CONFIGS_SSH="${SRV_SYS_CONFIGS}/ssh"

# iptables
SRV_SYS_IPTABLES="${SRV_SYS_BASE}/iptables"
SRV_SYS_IPTABLES_V4="${SRV_SYS_IPTABLES}/v4"
SRV_SYS_IPTABLES_V6="${SRV_SYS_IPTABLES}/v6"
SRV_SYS_IPTABLES_COMBINED_V4="${SRV_SYS_IPTABLES_V4}/combined.v4"
SRV_SYS_IPTABLES_COMBINED_V6="${SRV_SYS_IPTABLES_V6}/combined.v6"

# systemd
SRV_SYS_SYSTEMD="${SRV_SYS_BASE}/systemd"
SRV_SYS_SYSTEMD_SYSTEM="${SRV_SYS_SYSTEMD}/system"

# SSH
SRV_SYS_SSH="${SRV_SYS_BASE}/ssh"
SRV_SYS_SSH_WIN_CONFIG="${SRV_SYS_SSH}/win_config"
SRV_SYS_SSH_SESSIONS="${SRV_SYS_SSH}/ssh_session"
SRV_SYS_SSH_SESSIONS_ACTIVE="${SRV_SYS_SSH_SESSIONS}/active"
SRV_SYS_SSH_SESSIONS_ARCHIVE="${SRV_SYS_SSH_SESSIONS}/archive"
SRV_SYS_SSH_SESSIONS_METADATA="${SRV_SYS_SSH_SESSIONS}/metadata"
SRV_SYS_SSH_SSHD_CONFIG_D="${SRV_SYS_SSH}/sshd_config.d"
SRV_SYS_SSH_AUTHORIZED_KEYS="${SRV_SYS_SSH}/authorized_keys"

# Резервные копии
SRV_SYS_BACKUPS="${SRV_SYS_BASE}/backups"
SRV_SYS_BACKUPS_CONFIGS="${SRV_SYS_BACKUPS}/configs"
SRV_SYS_BACKUPS_IPTABLES="${SRV_SYS_BACKUPS}/iptables"
SRV_SYS_BACKUPS_SSH="${SRV_SYS_BACKUPS}/ssh"

# Скрипты
SRV_SYS_SCRIPTS="${SRV_SYS_BASE}/scripts"
SRV_SYS_SCRIPTS_DEPLOY="${SRV_SYS_SCRIPTS}/deploy"
SRV_SYS_SCRIPTS_MAINTENANCE="${SRV_SYS_SCRIPTS}/maintenance"
SRV_SYS_SCRIPTS_MONITORING="${SRV_SYS_SCRIPTS}/monitoring"

# Логи
SRV_SYS_LOGS="${SRV_SYS_BASE}/logs"

# Хуки
SRV_SYS_HOOKS="${SRV_SYS_BASE}/hooks"
SRV_SYS_HOOKS_PRE_DEPLOY="${SRV_SYS_HOOKS}/pre-deploy"
SRV_SYS_HOOKS_POST_DEPLOY="${SRV_SYS_HOOKS}/post-deploy"
SRV_SYS_HOOKS_PRE_UPDATE="${SRV_SYS_HOOKS}/pre-update"
SRV_SYS_HOOKS_POST_UPDATE="${SRV_SYS_HOOKS}/post-update"

# Манифест и данные
SRV_SYS_MANIFEST="${SRV_SYS_BASE}/manifest.json"
SRV_SYS_STATE_FILE="${SRV_SYS_BASE}/.deployment_state.json"
SRV_SYS_USERS_DB="${SRV_SYS_BASE}/.users_db.json"

################################################################################
# СЕТЕВАЯ КОНФИГУРАЦИЯ
################################################################################

# Главный IP адрес сервера
SRV_SYS_IP_ADDRESS=""  # Автоопределяется при инициализации

# Hostname
SRV_SYS_HOSTNAME=""  # Автоопределяется при инициализации

# Сетевые интерфейсы
SRV_SYS_PRIMARY_INTERFACE="eth0"
SRV_SYS_SECONDARY_INTERFACE=""

# DNS серверы
SRV_SYS_DNS_PRIMARY="8.8.8.8"
SRV_SYS_DNS_SECONDARY="8.8.4.4"

################################################################################
# SSH КОНФИГУРАЦИЯ
################################################################################

# SSH порт (изменяется через iptables контроллер)
SRV_SYS_SSH_PORT="22"

# SSH Gate конфигурация
SRV_SYS_SSH_GATE_ENABLED="false"
SRV_SYS_SSH_GATE_USER="gate"
SRV_SYS_SSH_GATE_PORT="22"
SRV_SYS_SSH_GATE_IP=""

# SID система
SRV_SYS_SSH_SID_ENABLED="false"
SRV_SYS_SSH_SID_LOG_FORMAT="detailed"  # simple | detailed | json

# Win_Config автоматизация
SRV_SYS_WIN_CONFIG_ENABLED="false"
SRV_SYS_WIN_CONFIG_AUTO_SYNC="true"

################################################################################
# IPTABLES КОНФИГУРАЦИЯ
################################################################################

# Включение iptables контроллера
SRV_SYS_IPTABLES_ENABLED="true"

# Режим работы: modular | monolithic
SRV_SYS_IPTABLES_MODE="modular"

# Автоприменение правил при изменении
SRV_SYS_IPTABLES_AUTO_APPLY="true"

# Резервные копии перед применением
SRV_SYS_IPTABLES_BACKUP_BEFORE_APPLY="true"

# IPv6 поддержка
SRV_SYS_IPTABLES_IPV6_ENABLED="true"

# Политика по умолчанию
SRV_SYS_IPTABLES_DEFAULT_INPUT_POLICY="DROP"
SRV_SYS_IPTABLES_DEFAULT_FORWARD_POLICY="DROP"
SRV_SYS_IPTABLES_DEFAULT_OUTPUT_POLICY="ACCEPT"

################################################################################
# СЕРВИСЫ - ПОРТЫ
################################################################################

# Web серверы
SRV_SYS_PORT_HTTP="80"
SRV_SYS_PORT_HTTPS="443"
SRV_SYS_PORT_HTTP_ALT="8080"
SRV_SYS_PORT_HTTPS_ALT="8443"

# Базы данных
SRV_SYS_PORT_MYSQL="3306"
SRV_SYS_PORT_POSTGRESQL="5432"
SRV_SYS_PORT_REDIS="6379"
SRV_SYS_PORT_MONGODB="27017"

# Другие сервисы
SRV_SYS_PORT_FTP="21"
SRV_SYS_PORT_DNS="53"
SRV_SYS_PORT_SMTP="25"
SRV_SYS_PORT_SMTP_SUBMISSION="587"
SRV_SYS_PORT_IMAP="143"
SRV_SYS_PORT_IMAPS="993"
SRV_SYS_PORT_POP3="110"
SRV_SYS_PORT_POP3S="995"

# Мониторинг
SRV_SYS_PORT_PROMETHEUS="9090"
SRV_SYS_PORT_GRAFANA="3000"
SRV_SYS_PORT_NODE_EXPORTER="9100"

# Docker
SRV_SYS_PORT_DOCKER="2376"
SRV_SYS_PORT_DOCKER_REGISTRY="5000"

################################################################################
# NGINX КОНФИГУРАЦИЯ
################################################################################

# Включение Nginx
SRV_SYS_NGINX_ENABLED="false"

# Worker процессы
SRV_SYS_NGINX_WORKER_PROCESSES="auto"

# Worker connections
SRV_SYS_NGINX_WORKER_CONNECTIONS="1024"

# Client body size
SRV_SYS_NGINX_CLIENT_MAX_BODY_SIZE="100M"

# Таймауты
SRV_SYS_NGINX_KEEPALIVE_TIMEOUT="65"
SRV_SYS_NGINX_SEND_TIMEOUT="60"

# Gzip сжатие
SRV_SYS_NGINX_GZIP_ENABLED="true"
SRV_SYS_NGINX_GZIP_LEVEL="6"

# SSL/TLS
SRV_SYS_NGINX_SSL_PROTOCOLS="TLSv1.2 TLSv1.3"
SRV_SYS_NGINX_SSL_CIPHERS="HIGH:!aNULL:!MD5"

################################################################################
# MYSQL/MARIADB КОНФИГУРАЦИЯ
################################################################################

# Включение MySQL
SRV_SYS_MYSQL_ENABLED="false"

# Bind address
SRV_SYS_MYSQL_BIND_ADDRESS="127.0.0.1"

# Max connections
SRV_SYS_MYSQL_MAX_CONNECTIONS="100"

# Buffer sizes
SRV_SYS_MYSQL_KEY_BUFFER_SIZE="16M"
SRV_SYS_MYSQL_MAX_ALLOWED_PACKET="16M"

# Логирование
SRV_SYS_MYSQL_SLOW_QUERY_LOG="1"
SRV_SYS_MYSQL_LONG_QUERY_TIME="2"

# Безопасность
SRV_SYS_MYSQL_LOCAL_INFILE="0"

################################################################################
# POSTGRESQL КОНФИГУРАЦИЯ
################################################################################

# Включение PostgreSQL
SRV_SYS_POSTGRESQL_ENABLED="false"

# Listen addresses
SRV_SYS_POSTGRESQL_LISTEN_ADDRESSES="localhost"

# Max connections
SRV_SYS_POSTGRESQL_MAX_CONNECTIONS="100"

# Shared buffers
SRV_SYS_POSTGRESQL_SHARED_BUFFERS="128MB"

# Work mem
SRV_SYS_POSTGRESQL_WORK_MEM="4MB"

# SSL
SRV_SYS_POSTGRESQL_SSL="on"

# Password encryption
SRV_SYS_POSTGRESQL_PASSWORD_ENCRYPTION="scram-sha-256"

################################################################################
# REDIS КОНФИГУРАЦИЯ
################################################################################

# Включение Redis
SRV_SYS_REDIS_ENABLED="false"

# Bind address
SRV_SYS_REDIS_BIND_ADDRESS="127.0.0.1"

# Max memory
SRV_SYS_REDIS_MAXMEMORY="256mb"

# Maxmemory policy
SRV_SYS_REDIS_MAXMEMORY_POLICY="allkeys-lru"

# Persistence
SRV_SYS_REDIS_SAVE_ENABLED="true"
SRV_SYS_REDIS_AOF_ENABLED="false"

################################################################################
# FAIL2BAN КОНФИГУРАЦИЯ
################################################################################

# Включение Fail2Ban
SRV_SYS_FAIL2BAN_ENABLED="false"

# Ban time (секунды)
SRV_SYS_FAIL2BAN_BANTIME="3600"

# Find time (секунды)
SRV_SYS_FAIL2BAN_FINDTIME="600"

# Max retry
SRV_SYS_FAIL2BAN_MAXRETRY="5"

# Jails
SRV_SYS_FAIL2BAN_SSHD_ENABLED="true"
SRV_SYS_FAIL2BAN_NGINX_ENABLED="false"
SRV_SYS_FAIL2BAN_MYSQL_ENABLED="false"

################################################################################
# РЕЗЕРВНЫЕ КОПИИ
################################################################################

# Включение автобэкапов
SRV_SYS_BACKUPS_ENABLED="true"

# Retention (дни)
SRV_SYS_BACKUPS_RETENTION_DAYS="30"

# Расписание (cron)
SRV_SYS_BACKUPS_SCHEDULE="0 2 * * *"  # Каждый день в 2:00

# Сжатие
SRV_SYS_BACKUPS_COMPRESSION="gzip"  # gzip | bzip2 | xz

# Уровень сжатия (1-9)
SRV_SYS_BACKUPS_COMPRESSION_LEVEL="6"

# Компоненты для бэкапа
SRV_SYS_BACKUPS_INCLUDE_CONFIGS="true"
SRV_SYS_BACKUPS_INCLUDE_IPTABLES="true"
SRV_SYS_BACKUPS_INCLUDE_SSH="true"
SRV_SYS_BACKUPS_INCLUDE_LOGS="false"

################################################################################
# МОНИТОРИНГ И УВЕДОМЛЕНИЯ
################################################################################

# Email уведомления
SRV_SYS_NOTIFY_EMAIL_ENABLED="false"
SRV_SYS_NOTIFY_EMAIL_TO=""
SRV_SYS_NOTIFY_EMAIL_FROM="root@localhost"

# Telegram уведомления
SRV_SYS_NOTIFY_TELEGRAM_ENABLED="false"
SRV_SYS_NOTIFY_TELEGRAM_BOT_TOKEN=""
SRV_SYS_NOTIFY_TELEGRAM_CHAT_ID=""

# Slack уведомления
SRV_SYS_NOTIFY_SLACK_ENABLED="false"
SRV_SYS_NOTIFY_SLACK_WEBHOOK_URL=""

# Логирование изменений
SRV_SYS_AUDIT_LOG_ENABLED="true"
SRV_SYS_AUDIT_LOG_FILE="${SRV_SYS_LOGS}/audit.log"

################################################################################
# ИНТЕГРАЦИЯ И АВТОМАТИЗАЦИЯ
################################################################################

# Автосинхронизация компонентов
SRV_SYS_AUTO_SYNC="true"

# Частота синхронизации (минуты)
SRV_SYS_SYNC_INTERVAL="5"

# Хуки
SRV_SYS_HOOKS_ENABLED="true"

# Service Discovery
SRV_SYS_SERVICE_DISCOVERY_ENABLED="true"

# Health checks
SRV_SYS_HEALTH_CHECK_ENABLED="true"
SRV_SYS_HEALTH_CHECK_INTERVAL="60"  # секунды

# Автоматическое восстановление
SRV_SYS_AUTO_RECOVERY_ENABLED="false"

################################################################################
# БЕЗОПАСНОСТЬ
################################################################################

# Уровень безопасности: minimal | standard | paranoid
SRV_SYS_SECURITY_LEVEL="standard"

# Автообновления безопасности
SRV_SYS_AUTO_SECURITY_UPDATES="true"

# Rate limiting
SRV_SYS_RATE_LIMIT_ENABLED="true"
SRV_SYS_RATE_LIMIT_CONNECTIONS="10"
SRV_SYS_RATE_LIMIT_WINDOW="60"  # секунды

# GeoIP блокировка
SRV_SYS_GEOIP_BLOCK_ENABLED="false"
SRV_SYS_GEOIP_ALLOWED_COUNTRIES=""  # RU,UA,BY

# Port knocking
SRV_SYS_PORT_KNOCKING_ENABLED="false"
SRV_SYS_PORT_KNOCKING_SEQUENCE="7000,8000,9000"

################################################################################
# ПРОИЗВОДИТЕЛЬНОСТЬ
################################################################################

# Оптимизация для типа нагрузки: web | database | mixed
SRV_SYS_OPTIMIZATION_PROFILE="mixed"

# Swap настройки
SRV_SYS_SWAPPINESS="10"

# TCP настройки
SRV_SYS_TCP_WINDOW_SCALING="1"
SRV_SYS_TCP_TIMESTAMPS="1"
SRV_SYS_TCP_SACK="1"

# File descriptors
SRV_SYS_MAX_OPEN_FILES="65535"

################################################################################
# DOCKER ИНТЕГРАЦИЯ
################################################################################

# Docker поддержка
SRV_SYS_DOCKER_ENABLED="false"

# Docker сети
SRV_SYS_DOCKER_NETWORK_BRIDGE="172.17.0.0/16"
SRV_SYS_DOCKER_NETWORK_CUSTOM="172.18.0.0/16"

# Docker volumes
SRV_SYS_DOCKER_VOLUMES_PATH="/srv/sys/docker/volumes"

# Docker registry
SRV_SYS_DOCKER_REGISTRY_ENABLED="false"
SRV_SYS_DOCKER_REGISTRY_URL=""

################################################################################
# РАЗРАБОТКА И ОТЛАДКА
################################################################################

# Debug режим
SRV_SYS_DEBUG="false"

# Verbose вывод
SRV_SYS_VERBOSE="false"

# Сухой запуск (dry-run)
SRV_SYS_DRY_RUN="false"

# Тестовый режим
SRV_SYS_TEST_MODE="false"

################################################################################
# КАСТОМНЫЕ ПЕРЕМЕННЫЕ
################################################################################

# Здесь можно добавлять свои переменные для специфичных нужд

################################################################################
# КОНЕЦ КОНФИГУРАЦИИ
################################################################################
